<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Gone with the ruins"><title>abseil status/status æºç åˆ†æ | KCçš„åºŸå¢Ÿå †</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">abseil status/status æºç åˆ†æ</h1><a id="logo" href="/.">KCçš„åºŸå¢Ÿå †</a><p class="description">Will you serve in Heaven, or rule in Hell</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/source-code-reading/"><i class="fa fa-archive"> æºç åˆ†æ</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">abseil status/status æºç åˆ†æ</h1><div class="post-meta">2024-05-12<span> | </span><span class="category"><a href="/categories/PROGRAMMING/">PROGRAMMING</a></span></div><a class="disqus-comment-count" data-disqus-identifier="2024/05/12/src-study-abseil-status-status/" href="/2024/05/12/src-study-abseil-status-status/#disqus_thread"></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Status-%E6%88%90%E5%91%98%E7%BB%93%E6%9E%84"><span class="toc-text">Status æˆå‘˜ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ok-Status"><span class="toc-text">Ok Status</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-absl-OkStatus"><span class="toc-text">1. absl::OkStatus()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-default-constructor"><span class="toc-text">2. default constructor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Status-absl-StatusCode-code-absl-string-view-msg"><span class="toc-text">3. Status(absl::StatusCode code, absl::string_view msg)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%8E%A8%E8%AE%BA%EF%BC%9A-Ok-status-%E7%9A%84-msg-%E6%98%AF%E4%BA%8B%E5%85%88%E7%A1%AC%E7%BC%96%E7%A0%81%E7%9A%84"><span class="toc-text">4. æ¨è®ºï¼š Ok status çš„ msg æ˜¯äº‹å…ˆç¡¬ç¼–ç çš„</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Non-ok-Status"><span class="toc-text">Non-ok Status</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Check-if-ok"><span class="toc-text">1. Check if ok</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E6%98%AF%E6%9F%90%E7%A7%8D%E9%94%99%E8%AF%AF"><span class="toc-text">2. æ£€æŸ¥æ˜¯å¦æ˜¯æŸç§é”™è¯¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AF%BB%E5%8F%96-code"><span class="toc-text">3. è¯»å– code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%8E%B7%E5%8F%96-message"><span class="toc-text">4. è·å– message</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Move-%E8%AF%AD%E4%B9%89%E5%A4%84%E7%90%86"><span class="toc-text">Move è¯­ä¹‰å¤„ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%A7%BB%E5%8A%A8%E6%9E%84%E9%80%A0"><span class="toc-text">1. ç§»åŠ¨æ„é€ </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%A7%BB%E5%8A%A8%E8%B5%8B%E5%80%BC"><span class="toc-text">2. ç§»åŠ¨èµ‹å€¼</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ref-counted-StatusRep"><span class="toc-text">Ref-counted StatusRep</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Copy-%E8%AF%AD%E4%B9%89%E6%93%8D%E4%BD%9C"><span class="toc-text">Copy è¯­ä¹‰æ“ä½œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%90%E6%9E%84"><span class="toc-text">ææ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E6%B5%81"><span class="toc-text">è¾“å‡ºæµ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ToString"><span class="toc-text">1. ToString</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Payload"><span class="toc-text">Payload</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Set-payload"><span class="toc-text">1. Set payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Get-payload"><span class="toc-text">2. Get payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Erase-payload"><span class="toc-text">3. Erase payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Visit-payloads"><span class="toc-text">4. Visit payloads</span></a></li></ol></li></ol></div></div><div class="post-content"><p>Revisionï¼š</p>
<ul>
<li>LTS_2024_01_16</li>
</ul>
<p>ğŸ’¡ LTS_2024_01_16 å¼€å§‹ rep_ æˆå‘˜çš„è§£é‡Šå¼€å§‹å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥ä¹‹å‰ç‰ˆæœ¬çš„éœ€è¦æ‰¾å¯¹åº”æºç </p>
<h2 id="Status-æˆå‘˜ç»“æ„"><a href="#Status-æˆå‘˜ç»“æ„" class="headerlink" title="Status æˆå‘˜ç»“æ„"></a>Status æˆå‘˜ç»“æ„</h2><p><code>Status</code> åªæœ‰ä¸€ä¸ªæˆå‘˜ï¼Œå³ <code>rep_</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Status supports two different representations.</span></span><br><span class="line"><span class="comment">//  - When the low bit is set it is an inlined representation.</span></span><br><span class="line"><span class="comment">//    It uses the canonical error space, no message or payload.</span></span><br><span class="line"><span class="comment">//    The error code is (rep_ &gt;&gt; 2).</span></span><br><span class="line"><span class="comment">//    The (rep_ &amp; 2) bit is the &quot;moved from&quot; indicator, used in IsMovedFrom().</span></span><br><span class="line"><span class="comment">//  - When the low bit is off it is an external representation.</span></span><br><span class="line"><span class="comment">//    In this case all the data comes from a heap allocated Rep object.</span></span><br><span class="line"><span class="comment">//    rep_ is a status_internal::StatusRep* pointer to that structure.</span></span><br><span class="line"><span class="type">uintptr_t</span> rep_;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª 64-bit é•¿çš„æˆå‘˜åšäº†ä¸€äº›ç©ºé—´ä¼˜åŒ–ï¼š</p>
<ul>
<li>å¯èƒ½æ˜¯ error code (<code>rep_ &gt;&gt; 2</code>)ï¼Œç§°ä¹‹ä¸º <em>inlined representation</em></li>
<li>ä¹Ÿå¯èƒ½ä»£è¡¨æŸä¸ªå †å†…å­˜çš„åœ°å€ï¼Œç±»å‹æ˜¯ <code>status_internal::StatusRep*</code></li>
</ul>
<p>ç¬¬ä¸€ç§æƒ…å†µå‡ºç°äºæ²¡æœ‰ message æˆ–è€… payload çš„æƒ…å†µä¸‹ï¼ŒæŒ‰ç…§ç›®å‰å®é™…çš„ä½¿ç”¨æƒ…å†µçœ‹ï¼Œå¯¹åº”çš„åŸºæœ¬æ˜¯è¿”å› Ok status çš„åœºæ™¯ï¼Œå› ä¸ºè¿™æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹çš„ç»“æœ</p>
<p>ğŸ’¡ å³ä½¿æ˜¯ non-ok statusï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰å…·ä½“ messageï¼Œè¿™ä¸ªæ—¶å€™ä¹Ÿæ˜¯ç¬¬ä¸€ç§æƒ…å†µ</p>
<p>åœ¨è¿™ä¸ªè®¾è®¡ä¸‹ Status æœ¬ä½“çš„å¤§å°åªæœ‰ 8-byteï¼Œåœ¨å‡½æ•°é—´ä¼ é€’éå¸¸è½»é‡</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 8-byte</span></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> size = <span class="built_in">sizeof</span>(absl::Status);</span><br></pre></td></tr></table></figure>

<h2 id="Ok-Status"><a href="#Ok-Status" class="headerlink" title="Ok Status"></a>Ok Status</h2><h3 id="1-absl-OkStatus"><a href="#1-absl-OkStatus" class="headerlink" title="1. absl::OkStatus()"></a>1. absl::OkStatus()</h3><p>æœ€æ¨èçš„æ–¹å¼ï¼Œä¹Ÿæ˜¯å¤§å¤šæ•°æ—¶å€™åˆ›å»º ok status çš„æ–¹å¼</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> Status <span class="title">OkStatus</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">Status</span>(); &#125;</span><br></pre></td></tr></table></figure>

<p>å†…éƒ¨å°±æ˜¯ç›´æ¥è°ƒç”¨ default constructor</p>
<h3 id="2-default-constructor"><a href="#2-default-constructor" class="headerlink" title="2. default constructor"></a>2. default constructor</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kOk == int(0)</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="title">Status::Status</span><span class="params">()</span> : rep_(CodeToInlinedRep(absl::StatusCode::kOk)) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> <span class="type">uintptr_t</span> <span class="title">Status::CodeToInlinedRep</span><span class="params">(absl::StatusCode code)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="built_in">static_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(code) &lt;&lt; <span class="number">2</span>) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> absl::StatusCode <span class="title">Status::InlinedRepToCode</span><span class="params">(<span class="type">uintptr_t</span> rep)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">ABSL_ASSERT</span>(<span class="built_in">IsInlined</span>(rep));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;absl::StatusCode&gt;(rep &gt;&gt; <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> <span class="type">bool</span> <span class="title">Status::IsInlined</span><span class="params">(<span class="type">uintptr_t</span> rep)</span> </span>&#123; <span class="keyword">return</span> (rep &amp; <span class="number">1</span>) != <span class="number">0</span>; &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>inline rep æ¨¡å¼ä¸‹ï¼Œlow bitï¼ˆæœ€ä½ä½ï¼‰ä¸€å®šæ˜¯1ï¼Œè¿™ä¹Ÿæ˜¯ <code>Status::IsInlined()</code> çš„æ£€æŸ¥æ€è·¯</li>
<li>inline-rep-to-code çš„æ—¶å€™ä¸ç”¨ -1ï¼Œå› ä¸ºå³ç§»çš„æ—¶å€™ä¼šè‡ªåŠ¨è¦†ç›–æœ€ä½ä½</li>
</ul>
<h3 id="3-Status-absl-StatusCode-code-absl-string-view-msg"><a href="#3-Status-absl-StatusCode-code-absl-string-view-msg" class="headerlink" title="3. Status(absl::StatusCode code, absl::string_view msg)"></a>3. Status(absl::StatusCode code, absl::string_view msg)</h3><p>è¿™ä¸ªå‡½æ•°å†…éƒ¨ä¸“é—¨é’ˆå¯¹ <code>absl::StatusCode::kOk</code> åšäº†ä¼˜åŒ–ï¼Œå¦‚æœç”¨æˆ·çœŸçš„ç”¨è¿™ä¸ªæ„é€ å‡½æ•°å¹¶ä¸”ä¼ äº† <code>kOk</code> ï¼Œé‚£ä¹ˆ <code>msg</code> ä¼šè¢«å¿½ç•¥</p>
<p>æ³¨æ„ï¼š<code>StatusCode::kOk == 0</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Status::<span class="built_in">Status</span>(absl::StatusCode code, absl::string_view msg)</span><br><span class="line">    : <span class="built_in">rep_</span>(<span class="built_in">CodeToInlinedRep</span>(code)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (code != absl::StatusCode::kOk &amp;&amp; !msg.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    rep_ = <span class="built_in">PointerToRep</span>(<span class="keyword">new</span> status_internal::<span class="built_in">StatusRep</span>(code, msg, <span class="literal">nullptr</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-æ¨è®ºï¼š-Ok-status-çš„-msg-æ˜¯äº‹å…ˆç¡¬ç¼–ç çš„"><a href="#4-æ¨è®ºï¼š-Ok-status-çš„-msg-æ˜¯äº‹å…ˆç¡¬ç¼–ç çš„" class="headerlink" title="4. æ¨è®ºï¼š Ok status çš„ msg æ˜¯äº‹å…ˆç¡¬ç¼–ç çš„"></a>4. æ¨è®ºï¼š Ok status çš„ msg æ˜¯äº‹å…ˆç¡¬ç¼–ç çš„</h3><p>ç›´æ¥çœ‹ä¸€ä¸‹ <code>Status::ToString()</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> std::string <span class="title">Status::ToString</span><span class="params">(StatusToStringMode mode)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ok</span>() ? <span class="string">&quot;OK&quot;</span> : <span class="built_in">ToStringSlow</span>(mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Non-ok-Status"><a href="#Non-ok-Status" class="headerlink" title="Non-ok Status"></a>Non-ok Status</h2><p>ä»¥ InternalError ä¸ºä¾‹ï¼Œä¸€èˆ¬åˆ›å»º non-ok status çš„åšæ³•æ˜¯ç”¨ help function</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> s = absl::<span class="built_in">InternalError</span>(<span class="string">&quot;something went wrong&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>ç­‰ä»·äº</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">InternalError</span><span class="params">(absl::string_view message)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Status</span>(absl::StatusCode::kInternal, message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Status::<span class="built_in">Status</span>(absl::StatusCode code, absl::string_view msg)</span><br><span class="line">    : <span class="built_in">rep_</span>(<span class="built_in">CodeToInlinedRep</span>(code)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (code != absl::StatusCode::kOk &amp;&amp; !msg.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    rep_ = <span class="built_in">PointerToRep</span>(<span class="keyword">new</span> status_internal::<span class="built_in">StatusRep</span>(code, msg, <span class="literal">nullptr</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºè¿™æ¬¡ <code>msg</code> ä¸ä¸ºç©ºï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºé¢å¤–çš„ Rep å¯¹è±¡</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">rep_ = <span class="built_in">PointerToRep</span>(<span class="keyword">new</span> status_internal::<span class="built_in">StatusRep</span>(code, msg, <span class="literal">nullptr</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">uintptr_t</span> <span class="title">Status::PointerToRep</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    absl::Nonnull&lt;status_internal::StatusRep*&gt; rep)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(rep);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> absl::Nonnull&lt;<span class="type">const</span> status_internal::StatusRep*&gt; <span class="title">Status::RepToPointer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uintptr_t</span> rep)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">IsInlined</span>(rep));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> status_internal::StatusRep*&gt;(rep);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StatusRep</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">StatusRep</span>(absl::StatusCode code_arg, absl::string_view message_arg,</span><br><span class="line">            std::unique_ptr&lt;status_internal::Payloads&gt; payloads_arg)</span><br><span class="line">      : <span class="built_in">ref_</span>(<span class="type">int32_t</span>&#123;<span class="number">1</span>&#125;),</span><br><span class="line">        <span class="built_in">code_</span>(code_arg),</span><br><span class="line">        <span class="built_in">message_</span>(message_arg),</span><br><span class="line">        <span class="built_in">payloads_</span>(std::<span class="built_in">move</span>(payloads_arg)) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">absl::StatusCode <span class="title">code</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> code_; &#125;</span><br><span class="line">  <span class="function"><span class="type">const</span> std::string&amp; <span class="title">message</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> message_; &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">mutable</span> std::atomic&lt;<span class="type">int32_t</span>&gt; ref_;</span><br><span class="line">  absl::StatusCode code_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// As an internal implementation detail, we guarantee that if status.message()</span></span><br><span class="line">  <span class="comment">// is non-empty, then the resulting string_view is null terminated.</span></span><br><span class="line">  <span class="comment">// This is required to implement &#x27;StatusMessageAsCStr(...)&#x27;</span></span><br><span class="line">  std::string message_;</span><br><span class="line">  std::unique_ptr&lt;status_internal::Payloads&gt; payloads_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å½“ Status éœ€è¦è¡¨ç¤º non-trivial case æ—¶å°±éœ€è¦åŠ¨æ€åˆ›å»º <code>StatusRep</code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¿å­˜ï¼š</p>
<ul>
<li>status code</li>
<li>message</li>
<li>payload</li>
<li>ref countï¼Œå› ä¸ºæ˜¯æ–°æ„é€ å®ä¾‹ï¼Œæ‰€ä»¥è®¡æ•°è‡ªåŠ¨è®¾ç½®ä¸º1</li>
</ul>
<p>å¹¶ä¸”å½“å‰å®ç°ç‰ˆæœ¬ï¼Œ<code>rep_</code> ä¿å­˜çš„å°±æ˜¯è¿™ä¸ªå †ä¸Šå¯¹è±¡çš„æŒ‡é’ˆ</p>
<h3 id="1-Check-if-ok"><a href="#1-Check-if-ok" class="headerlink" title="1. Check if ok"></a>1. Check if ok</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> ok = s.<span class="built_in">ok</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">Status::ok</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> rep_ == <span class="built_in">CodeToInlinedRep</span>(absl::StatusCode::kOk);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ²¡æœ‰å…ˆè·å– status code å†æ¯”è¾ƒæ˜¯å¦æ˜¯ kOkï¼Œåº”è¯¥æ˜¯ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œæ¯•ç«Ÿè¿™ä¸ªè°ƒç”¨æ˜¯åŠå…¶é«˜é¢‘çš„</p>
<p>æ³¨æ„ï¼Œä¸ºäº†ä¿è¯ OK status å…·æœ‰å”¯ä¸€çš„ rep å€¼ï¼Œå¯¹äº OK status çš„æƒ…å†µä¸€å®šä¸èƒ½ä½¿ç”¨åŠ¨æ€åˆ†é…çš„ StatusRep ä¿å­˜</p>
<p>è¿™ä¹Ÿæ˜¯å‰é¢å¯¹äº OK status ä¼šè‡ªåŠ¨ä¸¢å¼ƒ message çš„åŸå› </p>
<h3 id="2-æ£€æŸ¥æ˜¯å¦æ˜¯æŸç§é”™è¯¯"><a href="#2-æ£€æŸ¥æ˜¯å¦æ˜¯æŸç§é”™è¯¯" class="headerlink" title="2. æ£€æŸ¥æ˜¯å¦æ˜¯æŸç§é”™è¯¯"></a>2. æ£€æŸ¥æ˜¯å¦æ˜¯æŸç§é”™è¯¯</h3><p>å…¶å®å°±æ˜¯å¸¸ç”¨çš„ <code>absl::IsXXXX()</code></p>
<p>è¿™ç±»ä¾ç„¶ä»¥ InternalError ä¸ºä¾‹</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IsInternal</span><span class="params">(<span class="type">const</span> Status&amp; status)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> status.<span class="built_in">code</span>() == absl::StatusCode::kInternal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ—¢ç„¶ä¸æ˜¯é«˜é¢‘è°ƒç”¨ï¼Œå°±èµ°ä¼ ç»Ÿä¸€ç‚¹çš„åšæ³•ï¼Œè·å– status code è¿›è¡Œæ¯”è¾ƒ</p>
<p>å…¶ä»–ç±»åˆ«çš„ä¹Ÿæ˜¯ç±»ä¼¼çš„å¤„ç†</p>
<h3 id="3-è¯»å–-code"><a href="#3-è¯»å–-code" class="headerlink" title="3. è¯»å– code"></a>3. è¯»å– code</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> absl::StatusCode <span class="title">Status::code</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> status_internal::<span class="built_in">MapToLocalCode</span>(<span class="built_in">raw_code</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">int</span> <span class="title">Status::raw_code</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsInlined</span>(rep_)) <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(<span class="built_in">InlinedRepToCode</span>(rep_));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(<span class="built_in">RepToPointer</span>(rep_)-&gt;<span class="built_in">code</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">absl::StatusCode <span class="title">StatusRep::code</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> code_; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Convert canonical code to a value known to this binary.</span></span><br><span class="line"><span class="function">absl::StatusCode <span class="title">MapToLocalCode</span><span class="params">(<span class="type">int</span> value)</span> </span>&#123;</span><br><span class="line">  absl::StatusCode code = <span class="built_in">static_cast</span>&lt;absl::StatusCode&gt;(value);</span><br><span class="line">  <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kOk:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kCancelled:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kUnknown:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kInvalidArgument:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kDeadlineExceeded:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kNotFound:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kAlreadyExists:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kPermissionDenied:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kResourceExhausted:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kFailedPrecondition:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kAborted:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kOutOfRange:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kUnimplemented:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kInternal:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kUnavailable:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kDataLoss:</span><br><span class="line">    <span class="keyword">case</span> absl::StatusCode::kUnauthenticated:</span><br><span class="line">      <span class="keyword">return</span> code;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> absl::StatusCode::kUnknown;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>è·å– raw code æ—¶éœ€è¦è€ƒè™‘å½“å‰å†…éƒ¨çš„ repï¼Œåˆ†åˆ«è·å–</li>
<li>æœ€åè¿”å›å‰è¿˜éœ€è¦åšä¸€ä¸ªæ˜¯å¦å½“å‰å®ç°å¯è¯†åˆ«çš„ status code æ£€æŸ¥ï¼›ä¸è®¤è¯†çš„ä¸€å¾‹å½“ä½œ unknown è¿”å›</li>
</ul>
<p>è¿™æ ·ä¸€å¥—ä¸‹æ¥ç¡®å®ä¸å¤ªé€‚åˆä½œä¸º <code>ok()</code> è¿™æ ·çš„é«˜é¢‘è°ƒç”¨çš„å®ç°</p>
<h3 id="4-è·å–-message"><a href="#4-è·å–-message" class="headerlink" title="4. è·å– message"></a>4. è·å– message</h3><p>å‰é¢æåˆ°äº† non-ok status è¦å­˜å‚¨ error message çš„è¯å°±è¦é¢å¤–åœ¨å †ä¸Šåˆ›å»ºä¸€ä¸ª StatusRep å¯¹è±¡æ¥å­˜æ”¾ error messageï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†è¯»å–ç±»ä¼¼å‰é¢çš„ raw codeï¼Œè¦ä» StatusRep ä¸Šå–</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> absl::string_view <span class="title">Status::message</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !<span class="built_in">IsInlined</span>(rep_)</span><br><span class="line">             ? <span class="built_in">RepToPointer</span>(rep_)-&gt;<span class="built_in">message</span>()</span><br><span class="line">             : (<span class="built_in">IsMovedFrom</span>(rep_) ? absl::<span class="built_in">string_view</span>(kMovedFromString)</span><br><span class="line">                                  : absl::<span class="built_in">string_view</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MSVC 14.0 limitation requires the const.</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">const</span> <span class="type">char</span> kMovedFromString[] =</span><br><span class="line">    <span class="string">&quot;Status accessed after move.&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 = 0b10</span></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> <span class="type">bool</span> <span class="title">Status::IsMovedFrom</span><span class="params">(<span class="type">uintptr_t</span> rep)</span> </span>&#123; <span class="keyword">return</span> (rep &amp; <span class="number">2</span>) != <span class="number">0</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>ç‰¹åœ°é’ˆå¯¹ moved status åšäº†å¤„ç†ï¼ŒçŒœæµ‹æ˜¯ä¸ºäº†å‘ç°æ½œåœ¨ use-after-move ç‰¹æ„åšçš„</p>
<p>ğŸ’¡ OkStatus çš„ <code>message()</code> ä¹Ÿè¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„å’Œ <code>ToString()</code> æ˜¯ä¸åŒçš„</p>
<h2 id="Move-è¯­ä¹‰å¤„ç†"><a href="#Move-è¯­ä¹‰å¤„ç†" class="headerlink" title="Move è¯­ä¹‰å¤„ç†"></a>Move è¯­ä¹‰å¤„ç†</h2><p>ä¸Šé¢æåˆ° Status ç‰¹æ„é’ˆå¯¹ move åšäº†ä¸€äº›å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ç»§ç»­çœ‹å®ƒçš„ move ctor å’Œ move assignment</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The moved-from state is valid but unspecified.</span></span><br><span class="line"><span class="built_in">Status</span>(Status&amp;&amp;) <span class="keyword">noexcept</span>;</span><br><span class="line">Status&amp; <span class="keyword">operator</span>=(Status&amp;&amp;);</span><br></pre></td></tr></table></figure>

<ul>
<li>move ctor æ˜¯ noexcept ä½†æ˜¯ move assignment å¹¶ä¸æ˜¯</li>
</ul>
<h3 id="1-ç§»åŠ¨æ„é€ "><a href="#1-ç§»åŠ¨æ„é€ " class="headerlink" title="1. ç§»åŠ¨æ„é€ "></a>1. ç§»åŠ¨æ„é€ </h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="title">Status::Status</span><span class="params">(Status&amp;&amp; x)</span> <span class="keyword">noexcept</span> : Status(x.rep_) &#123;</span></span><br><span class="line">  x.rep_ = <span class="built_in">MovedFromRep</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// It&#x27;s in private access leve.</span></span><br><span class="line"><span class="comment">// Underlying constructor for status from a rep_.</span></span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">Status</span><span class="params">(<span class="type">uintptr_t</span> rep)</span> : rep_(rep) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Status code is set to (kInternal | mark)</span></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> <span class="type">uintptr_t</span> <span class="title">Status::MovedFromRep</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">CodeToInlinedRep</span>(absl::StatusCode::kInternal) | <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ç§æœ‰çš„æ„é€ ç›´æ¥è®©æ–°å¯¹è±¡ä½¿ç”¨ moved-from å¯¹è±¡çš„ rep</p>
<p>ç„¶åå°† moved-from å¯¹è±¡çš„ rep ä¸“é—¨è®¾ç½®ä¸ºä¸€ä¸ªå¸¦ bit-mark çš„å€¼</p>
<p>æ³¨æ„ï¼Œè¿™ä¸ª rep ä»ç„¶æ˜¯æ»¡è¶³ <code>IsInlined()</code> çš„ï¼Œå› ä¸ºå®ƒçš„æœ€ä½ä½æ˜¯ 1ï¼›æ‰€ä»¥è¿™é‡Œçš„ moved-from bit mark æ˜¯æ¬¡ä½ä½</p>
<p>å¯¹ Status å¯¹è±¡æ¥è¯´ï¼Œåªè¦æ˜¯ inlined repï¼Œå°±è¯´æ˜æ²¡æœ‰å…³è”å †ä¸Šåˆ†é…çš„ StatusRepï¼Œè‡ªèº«ææ„çš„æ—¶å€™ä¸éœ€è¦åšä»»ä½•é¢å¤–çš„æ“ä½œ</p>
<h3 id="2-ç§»åŠ¨èµ‹å€¼"><a href="#2-ç§»åŠ¨èµ‹å€¼" class="headerlink" title="2. ç§»åŠ¨èµ‹å€¼"></a>2. ç§»åŠ¨èµ‹å€¼</h3><p>ç§»åŠ¨èµ‹å€¼éœ€è¦å¤„ç†åŸå¯¹è±¡ï¼Œæ‰€ä»¥ä¼šéº»çƒ¦ä¸€äº›</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> Status&amp; Status::<span class="keyword">operator</span>=(Status&amp;&amp; x) &#123;</span><br><span class="line">  <span class="type">uintptr_t</span> old_rep = rep_;</span><br><span class="line">  <span class="keyword">if</span> (x.rep_ != old_rep) &#123;</span><br><span class="line">    rep_ = x.rep_;</span><br><span class="line">    x.rep_ = <span class="built_in">MovedFromRep</span>();</span><br><span class="line">    <span class="built_in">Unref</span>(old_rep);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Status::Unref</span><span class="params">(<span class="type">uintptr_t</span> rep)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">IsInlined</span>(rep)) <span class="built_in">RepToPointer</span>(rep)-&gt;<span class="built_in">Unref</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>x.rep_ != old_rep</code> æˆç«‹æœ‰ä¸¤ç§æƒ…å†µ</p>
<ol>
<li>ä¸¤ä¸ª status éƒ½æ˜¯ inlined repï¼Œè¿™ç§æ˜¯ trivial caseï¼Œä¸éœ€è¦åšä»»ä½•äº‹</li>
<li>ä¸¤ä¸ª status éƒ½æ˜¯ non-inlined repï¼Œå¹¶ä¸”å†…éƒ¨éƒ½æŒ‡å‘åŒä¸€ä¸ªå †ä¸Šçš„ StatusRepï¼›è¿™ç§æƒ…å†µä¹Ÿä¸éœ€è¦åšä»»ä½•æ“ä½œ</li>
</ol>
<p>å› ä¸ºå †ä¸Šçš„ StatusRep æ˜¯è‡ªå¸¦å¼•ç”¨è®¡æ•°çš„ï¼Œæ‰€ä»¥ç§»åŠ¨åï¼ŒåŸæ¥çš„ StatusRep çš„è®¡æ•°éœ€è¦è‡ªå‡</p>
<p>ğŸ’¡ å…¶å®ä¸¥æ ¼æ¥è¯´ç§»åŠ¨èµ‹å€¼è¿™é‡Œä¹Ÿæ˜¯å¯ä»¥å®ç°æˆ noexcept çš„ï¼Œ<code>Unref()</code> å¹¶æœªæ¶‰åŠå¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„æ“ä½œï¼Œå¹¶ä¸”åæ–‡å¯ä»¥å‘ç°ææ„å‡½æ•°ç›´æ¥å°±è°ƒç”¨è¿™ä¸ª</p>
<h2 id="Ref-counted-StatusRep"><a href="#Ref-counted-StatusRep" class="headerlink" title="Ref-counted StatusRep"></a>Ref-counted StatusRep</h2><p>ä¸ºäº† non-inlined rep æƒ…å†µä¸‹ Status å¯¹è±¡ä¹Ÿèƒ½å¤Ÿ<strong>è½»é‡é«˜æ•ˆçš„ä¼ é€’</strong>ï¼Œ<code>StatusRep</code> è®¾è®¡ä¸Šæ˜¯ ref-countedï¼Œå¹¶ä¸”è€ƒè™‘åˆ°äº†ä¸åŒçš„ Status å¯¹è±¡å†…éƒ¨å¼•ç”¨åŒä¸€ä¸ª <code>StatusRep</code> çš„æƒ…å†µï¼Œè¿™ä¸ª ref-counted æ˜¯å¯ä»¥åšåˆ° thread-safe çš„</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Status::Ref</span><span class="params">(<span class="type">uintptr_t</span> rep)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">IsInlined</span>(rep)) <span class="built_in">RepToPointer</span>(rep)-&gt;<span class="built_in">Ref</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Status::Unref</span><span class="params">(<span class="type">uintptr_t</span> rep)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">IsInlined</span>(rep)) <span class="built_in">RepToPointer</span>(rep)-&gt;<span class="built_in">Unref</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Internal</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StatusRep</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">mutable</span> std::atomic&lt;<span class="type">int32_t</span>&gt; ref_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ref and unref are const to allow access through a const pointer, and are</span></span><br><span class="line"><span class="comment">// used during copying operations.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">StatusRep::Ref</span><span class="params">()</span> <span class="type">const</span> </span>&#123; ref_.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">StatusRep::Unref</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Fast path: if ref==1, there is no need for a RefCountDec (since</span></span><br><span class="line">  <span class="comment">// this is the only reference and therefore no other thread is</span></span><br><span class="line">  <span class="comment">// allowed to be mucking with r).</span></span><br><span class="line">  <span class="keyword">if</span> (ref_.<span class="built_in">load</span>(std::memory_order_acquire) == <span class="number">1</span> ||</span><br><span class="line">      ref_.<span class="built_in">fetch_sub</span>(<span class="number">1</span>, std::memory_order_acq_rel) - <span class="number">1</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Status</code> çš„ <code>Ref()</code>&#x2F;<code>Unref()</code> æ˜¯ static å‡½æ•°</p>
<p><code>StatusRep::Unref()</code> çš„ fast path ä¼˜åŒ–çš„åŸå› æ˜¯ï¼š</p>
<ul>
<li>è™½ç„¶å¼•ç”¨è®¡æ•°æ˜¯ thread-safe çš„ï¼Œä½†æ˜¯ Status å¯¹è±¡æœ¬èº«ä¸æ˜¯ thread-safe</li>
<li>æ‰€ä»¥åœ¨éµå¾ª thread-safe access å‰æä¸‹ï¼Œå¦‚æœå½“å‰ Status çš„ rep reference count æ˜¯1ï¼Œåˆ™è¯´æ˜å½“å‰çš„ Status æ˜¯å”¯ä¸€ä¸€ä¸ª refer è¿™ä¸ª StatusRep çš„å¯¹è±¡ï¼Œå› ä¸ºå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ª Status æœ¬èº«å°±æ˜¯ non-thread-safe çš„</li>
</ul>
<p>è®¡æ•°å‡åˆ°0ä¹‹åçš„ delete this æ˜¯ä¾µå…¥å¼å¼•ç”¨è®¡æ•°çš„è€æ“ä½œäº†</p>
<h2 id="Copy-è¯­ä¹‰æ“ä½œ"><a href="#Copy-è¯­ä¹‰æ“ä½œ" class="headerlink" title="Copy è¯­ä¹‰æ“ä½œ"></a>Copy è¯­ä¹‰æ“ä½œ</h2><p>Status è¯­ä¹‰ä¸Šå‘ˆç°å€¼è¯­ä¹‰ï¼Œæ‰€ä»¥è‚¯å®šæ˜¯è¦æ”¯æŒ copy semantics çš„</p>
<p>Copy çš„å¤„ç†å’Œ Move éå¸¸åƒï¼Œæœ€å¤§çš„åŒºåˆ«åœ¨äºæºå¯¹è±¡éœ€è¦ç»§ç»­ä¿æŒï¼ŒåŒæ—¶å¦‚æœæ˜¯ non-inlined repï¼Œè®¡æ•°éœ€è¦è‡ªå¢ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="title">Status::Status</span><span class="params">(<span class="type">const</span> Status&amp; x)</span> : Status(x.rep_) &#123;</span> <span class="built_in">Ref</span>(rep_); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> Status&amp; Status::<span class="keyword">operator</span>=(<span class="type">const</span> Status&amp; x) &#123;</span><br><span class="line">  <span class="type">uintptr_t</span> old_rep = rep_;</span><br><span class="line">  <span class="keyword">if</span> (x.rep_ != old_rep) &#123;</span><br><span class="line">    <span class="built_in">Ref</span>(x.rep_);</span><br><span class="line">    rep_ = x.rep_;</span><br><span class="line">    <span class="built_in">Unref</span>(old_rep);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸º <code>Status::Ref()</code> å’Œ <code>Status::Unref()</code> å†…éƒ¨ä¼šé€æ˜åœ°å¤„ç† inlined rep çš„æƒ…å†µï¼Œæ‰€ä»¥æ‹·è´å’Œç§»åŠ¨çš„å®ç°ä¸Šéå¸¸å¹²å‡€</p>
<h2 id="ææ„"><a href="#ææ„" class="headerlink" title="ææ„"></a>ææ„</h2><p>åˆ†æå®Œ ref counting éƒ¨åˆ†ä¹‹åè¿™é‡Œå°±æ¯”è¾ƒç®€å•</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> Status::~<span class="built_in">Status</span>() &#123; <span class="built_in">Unref</span>(rep_); &#125;</span><br></pre></td></tr></table></figure>

<h2 id="è¾“å‡ºæµ"><a href="#è¾“å‡ºæµ" class="headerlink" title="è¾“å‡ºæµ"></a>è¾“å‡ºæµ</h2><p>Status é‡è½½äº† <code>operator&lt;&lt;()</code> æ‰€ä»¥å¯ä»¥ç›´æ¥å¾€ stream è¾“å‡º</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">std::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(std::ostream&amp; os, <span class="type">const</span> Status&amp; x) &#123;</span><br><span class="line">  os &lt;&lt; x.<span class="built_in">ToString</span>(StatusToStringMode::kWithEverything);</span><br><span class="line">  <span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-ToString"><a href="#1-ToString" class="headerlink" title="1. ToString"></a>1. ToString</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> std::string <span class="title">Status::ToString</span><span class="params">(StatusToStringMode mode)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ok</span>() ? <span class="string">&quot;OK&quot;</span> : <span class="built_in">ToStringSlow</span>(rep_, mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Status::ToStringSlow</span><span class="params">(<span class="type">uintptr_t</span> rep, StatusToStringMode mode)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsInlined</span>(rep)) &#123;</span><br><span class="line">    <span class="keyword">return</span> absl::<span class="built_in">StrCat</span>(absl::<span class="built_in">StatusCodeToString</span>(<span class="built_in">InlinedRepToCode</span>(rep)), <span class="string">&quot;: &quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">RepToPointer</span>(rep)-&gt;<span class="built_in">ToString</span>(mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">StatusCodeToString</span><span class="params">(StatusCode code)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kOk:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kCancelled:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;CANCELLED&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kUnknown:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;UNKNOWN&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kInvalidArgument:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;INVALID_ARGUMENT&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kDeadlineExceeded:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;DEADLINE_EXCEEDED&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kNotFound:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;NOT_FOUND&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kAlreadyExists:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;ALREADY_EXISTS&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kPermissionDenied:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;PERMISSION_DENIED&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kUnauthenticated:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;UNAUTHENTICATED&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kResourceExhausted:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;RESOURCE_EXHAUSTED&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kFailedPrecondition:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;FAILED_PRECONDITION&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kAborted:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;ABORTED&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kOutOfRange:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;OUT_OF_RANGE&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kUnimplemented:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;UNIMPLEMENTED&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kInternal:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;INTERNAL&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kUnavailable:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;UNAVAILABLE&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> StatusCode::kDataLoss:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;DATA_LOSS&quot;</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">StatusRep::ToString</span><span class="params">(StatusToStringMode mode)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  std::string text;</span><br><span class="line">  absl::<span class="built_in">StrAppend</span>(&amp;text, absl::<span class="built_in">StatusCodeToString</span>(<span class="built_in">code</span>()), <span class="string">&quot;: &quot;</span>, <span class="built_in">message</span>());</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">bool</span> with_payload = (mode &amp; StatusToStringMode::kWithPayload) ==</span><br><span class="line">                            StatusToStringMode::kWithPayload;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (with_payload) &#123;</span><br><span class="line">    status_internal::StatusPayloadPrinter printer =</span><br><span class="line">        status_internal::<span class="built_in">GetStatusPayloadPrinter</span>();</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">ForEachPayload</span>([&amp;](absl::string_view type_url,</span><br><span class="line">                             <span class="type">const</span> absl::Cord&amp; payload) &#123;</span><br><span class="line">      absl::optional&lt;std::string&gt; result;</span><br><span class="line">      <span class="keyword">if</span> (printer) result = <span class="built_in">printer</span>(type_url, payload);</span><br><span class="line">      absl::<span class="built_in">StrAppend</span>(</span><br><span class="line">          &amp;text, <span class="string">&quot; [&quot;</span>, type_url, <span class="string">&quot;=&#x27;&quot;</span>,</span><br><span class="line">          result.<span class="built_in">has_value</span>() ? *result : absl::<span class="built_in">CHexEscape</span>(std::<span class="built_in">string</span>(payload)),</span><br><span class="line">          <span class="string">&quot;&#x27;]&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> text;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>OK Status ä¼šæœ‰ short cut, è¿™ä¸ªå‰é¢ä¹Ÿåˆ†æè¿‡äº†</li>
<li>å¦‚æœæ˜¯ Inlined rep åˆ™ä¸ç®¡æ˜¯ä¸æ˜¯ ok statusï¼Œéƒ½æ²¡æœ‰ messageï¼Œæ‰€ä»¥åªéœ€è¦è¿”å› status code å¯¹åº”çš„æ–‡å­—æè¿°å³å¯ï¼Œè¿™é‡Œ <code>StatusCodeToString()</code> æ²¡æœ‰ç”¨é¢å¤–çš„æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯ç›´æ¥ç”¨ switch..case æ‰“è¡¨</li>
<li>æœ‰ message åˆ™ä¸€å®šæ˜¯ non-inlined repï¼Œé‚£å°±è¦æŠŠ status code æ‹¼ä¸Š message</li>
<li>å¦‚æœæœ‰é¢å¤–çš„ payloadï¼ˆå­˜å‚¨åœ¨ StatusRep ä¸Šï¼Œå…·ä½“åæ–‡åˆ†æï¼‰åˆ™å¦‚æœ mode éœ€è¦ stringify payload åˆ™è¦ä¸€å¹¶å¤„ç†</li>
</ol>
<h2 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h2><p>è¿™ä¸ªåŠŸèƒ½åº”è¯¥æ˜¯ Google å†…éƒ¨çš„éœ€æ±‚å§ï¼Œèµ·ç æˆ‘è‡ªå·±åœ¨æ—¥å¸¸ä¸­å‡ ä¹æ²¡ç”¨è¿‡â€¦</p>
<p>Abseil-cpp è¦æ±‚ payload éœ€è¦ä»¥ <code>[key, value]</code> pair çš„æ–¹å¼ç®¡ç†ï¼Œå¹¶ä¸”</p>
<ul>
<li>key è¦ç¬¦åˆ URL çš„æ ¼å¼è§„èŒƒ</li>
<li>value çš„ç±»å‹æ˜¯ <code>absl::Cord</code>ï¼Œä¸€ä¸ªè½¬ä¸º large string data ä¼˜åŒ–çš„ string-like type</li>
</ul>
<h3 id="1-Set-payload"><a href="#1-Set-payload" class="headerlink" title="1. Set payload"></a>1. Set payload</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Status::SetPayload</span><span class="params">(absl::string_view type_url, absl::Cord payload)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ok</span>()) <span class="keyword">return</span>;</span><br><span class="line">  status_internal::StatusRep* rep = <span class="built_in">PrepareToModify</span>(rep_);</span><br><span class="line">  rep-&gt;<span class="built_in">SetPayload</span>(type_url, std::<span class="built_in">move</span>(payload));</span><br><span class="line">  rep_ = <span class="built_in">PointerToRep</span>(rep);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function">absl::Nonnull&lt;status_internal::StatusRep*&gt; <span class="title">Status::PrepareToModify</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uintptr_t</span> rep)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsInlined</span>(rep)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> status_internal::<span class="built_in">StatusRep</span>(<span class="built_in">InlinedRepToCode</span>(rep),</span><br><span class="line">                                          absl::<span class="built_in">string_view</span>(), <span class="literal">nullptr</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">RepToPointer</span>(rep)-&gt;<span class="built_in">CloneAndUnref</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">absl::Nonnull&lt;StatusRep*&gt; <span class="title">StatusRep::CloneAndUnref</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Optimization: no need to create a clone if we already have a refcount of 1.</span></span><br><span class="line">  <span class="keyword">if</span> (ref_.<span class="built_in">load</span>(std::memory_order_acquire) == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// All StatusRep instances are heap allocated and mutable, therefore this</span></span><br><span class="line">    <span class="comment">// const_cast will never cast away const from a stack instance.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// CloneAndUnref is the only method that doesn&#x27;t involve an external cast to</span></span><br><span class="line">    <span class="comment">// get a mutable StatusRep* from the uintptr_t rep stored in Status.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">const_cast</span>&lt;StatusRep*&gt;(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  std::unique_ptr&lt;status_internal::Payloads&gt; payloads;</span><br><span class="line">  <span class="keyword">if</span> (payloads_) &#123;</span><br><span class="line">    payloads = absl::<span class="built_in">make_unique</span>&lt;status_internal::Payloads&gt;(*payloads_);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span>* new_rep = <span class="keyword">new</span> <span class="built_in">StatusRep</span>(code_, message_, std::<span class="built_in">move</span>(payloads));</span><br><span class="line">  <span class="built_in">Unref</span>();</span><br><span class="line">  <span class="keyword">return</span> new_rep;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line">std::unique_ptr&lt;status_internal::Payloads&gt; StatusRep::payloads_;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">StatusRep::SetPayload</span><span class="params">(absl::string_view type_url, absl::Cord payload)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (payloads_ == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    payloads_ = absl::<span class="built_in">make_unique</span>&lt;status_internal::Payloads&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  absl::optional&lt;<span class="type">size_t</span>&gt; index =</span><br><span class="line">      status_internal::<span class="built_in">FindPayloadIndexByUrl</span>(payloads_.<span class="built_in">get</span>(), type_url);</span><br><span class="line">  <span class="keyword">if</span> (index.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">    (*payloads_)[index.<span class="built_in">value</span>()].payload = std::<span class="built_in">move</span>(payload);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  payloads_-&gt;<span class="built_in">push_back</span>(&#123;std::<span class="built_in">string</span>(type_url), std::<span class="built_in">move</span>(payload)&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Container for status payloads.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Payload</span> &#123;</span><br><span class="line">  std::string type_url;</span><br><span class="line">  absl::Cord payload;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Payloads = absl::InlinedVector&lt;Payload, <span class="number">1</span>&gt;;</span><br></pre></td></tr></table></figure>

<p>OkStatus æ˜¯ä¸åº”è¯¥æºå¸¦ payload çš„ï¼Œæ‰€ä»¥ set ç›´æ¥è¿”å›</p>
<p>Non-ok status éœ€è¦åŒºåˆ†æ˜¯ä¸æ˜¯ inlined repï¼Œè¿™é‡Œçš„æ ¸å¿ƒç‚¹æ˜¯è¿™æ ·ï¼š</p>
<ul>
<li>StatusRep å¯èƒ½è¢«å¤šä¸ª Non-ok Status å…±äº«ï¼Œè€Œ set payload ä¼šéœ€è¦ä¿®æ”¹åˆ° StatusRep å†…éƒ¨çŠ¶æ€ï¼Œæ‰€ä»¥è¿™æœ¬åªæ˜¯ä¸€ä¸ª copy-on-write çš„æ“ä½œ</li>
<li>å¦‚æœæ˜¯ inlinedï¼Œåˆ™æ²¡æœ‰å…±äº«çš„ StatusRepï¼Œæ‰€ä»¥åªéœ€è¦åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ StatusRep å°±è¡Œ</li>
<li>å°ä¼˜åŒ–çš„ç›®çš„ä¹Ÿæ˜¯å¦‚æ­¤ï¼šè€ƒè™‘åˆ°å¤§å¤šæ•°æ—¶å€™ä¸€ä¸ª StatusRep ä¸ä¼šè¢«å¤šä¸ª Status å…±äº«ï¼Œæ‰€ä»¥å•ç‹¬åˆ¤æ–­è®¡æ•°æ¥åš short cut è¿˜æ˜¯æœ‰ä¼˜åŠ¿çš„</li>
</ul>
<p><code>absl::InlinedVector</code> æ˜¯ absl çš„ç±» SSO çš„ vector ä¼˜åŒ–ç‰ˆæœ¬ï¼Œè¿™é‡Œ unique_ptr æ¥ä¿å­˜ inlined vector ä¹Ÿç®—ä¸€ä¸ªä¼˜åŒ–ï¼šå› ä¸ºå¤§å¤šæ•°æ—¶å€™ status æ˜¯æ²¡æœ‰ payload çš„ï¼Œæ‰€ä»¥ä¸å¸Œæœ›ç™½ç™½æµªè´¹å†…å­˜ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†åˆ©ç”¨ unique_ptr ä»…åœ¨éœ€è¦çš„æ—¶å€™å­˜å‚¨ã€‚</p>
<p>è€Œå¦‚æœéœ€è¦ payload äº†ï¼Œå¤§å¤šæ•°æ—¶å€™éƒ½åªæœ‰ä¸€ä¸ªï¼ˆè€ƒè™‘ä¸€ä¸‹ <code>absl::Cord</code> èƒ½å­˜å¤§å­—ç¬¦ä¸²ï¼‰ï¼Œæ‰€ä»¥ç”¨ inlined vector è¿˜èƒ½é¿å…æ— è°“çš„åŠ¨æ€å†…å­˜åˆ†é…</p>
<h3 id="2-Get-payload"><a href="#2-Get-payload" class="headerlink" title="2. Get payload"></a>2. Get payload</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> absl::optional&lt;absl::Cord&gt; <span class="title">Status::GetPayload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    absl::string_view type_url)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsInlined</span>(rep_)) <span class="keyword">return</span> absl::<span class="literal">nullopt</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">RepToPointer</span>(rep_)-&gt;<span class="built_in">GetPayload</span>(type_url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">absl::optional&lt;absl::Cord&gt; <span class="title">StatusRep::GetPayload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    absl::string_view type_url)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  absl::optional&lt;<span class="type">size_t</span>&gt; index =</span><br><span class="line">      status_internal::<span class="built_in">FindPayloadIndexByUrl</span>(payloads_.<span class="built_in">get</span>(), type_url);</span><br><span class="line">  <span class="keyword">if</span> (index.<span class="built_in">has_value</span>()) <span class="keyword">return</span> (*payloads_)[index.<span class="built_in">value</span>()].payload;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> absl::<span class="literal">nullopt</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Get payload ä¸æ¶‰åŠä¿®æ”¹ï¼Œæ‰€ä»¥å¾ˆç›´æ¥çš„å®ç°ï¼Œæ²¡å•¥å¥½è¯´çš„</p>
<h3 id="3-Erase-payload"><a href="#3-Erase-payload" class="headerlink" title="3. Erase payload"></a>3. Erase payload</h3><p>erase ä¹Ÿæ˜¯ä¸€ä¸ªå†™æ“ä½œï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦å¤„ç† copy-on-write</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">Status::ErasePayload</span><span class="params">(absl::string_view type_url)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsInlined</span>(rep_)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  status_internal::StatusRep* rep = <span class="built_in">PrepareToModify</span>(rep_);</span><br><span class="line">  <span class="keyword">auto</span> res = rep-&gt;<span class="built_in">ErasePayload</span>(type_url);</span><br><span class="line">  rep_ = res.new_rep;</span><br><span class="line">  <span class="keyword">return</span> res.erased;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function">StatusRep::EraseResult <span class="title">StatusRep::ErasePayload</span><span class="params">(absl::string_view type_url)</span> </span>&#123;</span><br><span class="line">  absl::optional&lt;<span class="type">size_t</span>&gt; index =</span><br><span class="line">      status_internal::<span class="built_in">FindPayloadIndexByUrl</span>(payloads_.<span class="built_in">get</span>(), type_url);</span><br><span class="line">  <span class="keyword">if</span> (!index.<span class="built_in">has_value</span>()) <span class="keyword">return</span> &#123;<span class="literal">false</span>, Status::<span class="built_in">PointerToRep</span>(<span class="keyword">this</span>)&#125;;</span><br><span class="line">  payloads_-&gt;<span class="built_in">erase</span>(payloads_-&gt;<span class="built_in">begin</span>() + index.<span class="built_in">value</span>());</span><br><span class="line">  <span class="keyword">if</span> (payloads_-&gt;<span class="built_in">empty</span>() &amp;&amp; message_.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="comment">// Special case: If this can be represented inlined, it MUST be inlined</span></span><br><span class="line">    <span class="comment">// (== depends on this behavior).</span></span><br><span class="line">    EraseResult result = &#123;<span class="literal">true</span>, Status::<span class="built_in">CodeToInlinedRep</span>(code_)&#125;;</span><br><span class="line">    <span class="built_in">Unref</span>();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;<span class="literal">true</span>, Status::<span class="built_in">PointerToRep</span>(<span class="keyword">this</span>)&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Erase éƒ¨åˆ†æœ‰ä¸ªtrickï¼šå¦‚æœ erase payload ä¹‹åè¿™ä¸ª StatusRep å…¨ç©ºäº†ï¼Œå³ status å¯ä»¥è¢« inlined repï¼Œé‚£ä¹ˆå°±æŠŠä»– inlined repï¼›å¦åˆ™å‰é¢çš„ inlined&#x2F;non-inlined çš„å‰æå°±ä¸ä¸€è‡´äº†ã€‚</p>
<h3 id="4-Visit-payloads"><a href="#4-Visit-payloads" class="headerlink" title="4. Visit payloads"></a>4. Visit payloads</h3><p>è¿™éƒ¨åˆ†æ¯”è¾ƒæœ‰æ„æ€</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Status::ForEachPayload()</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Iterates over the stored payloads and calls the</span></span><br><span class="line"><span class="comment">// `visitor(type_key, payload)` callable for each one.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> The order of calls to `visitor()` is not specified and may change at</span></span><br><span class="line"><span class="comment">// any time.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> Any mutation on the same &#x27;absl::Status&#x27; object during visitation is</span></span><br><span class="line"><span class="comment">// forbidden and could result in undefined behavior.</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">Status::ForEachPayload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    absl::FunctionRef&lt;<span class="type">void</span>(absl::string_view, <span class="type">const</span> absl::Cord&amp;)&gt; visitor)</span></span></span><br><span class="line"><span class="function">    <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsInlined</span>(rep_)) <span class="keyword">return</span>;</span><br><span class="line">  <span class="built_in">RepToPointer</span>(rep_)-&gt;<span class="built_in">ForEachPayload</span>(visitor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">StatusRep::ForEachPayload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    absl::FunctionRef&lt;<span class="type">void</span>(absl::string_view, <span class="type">const</span> absl::Cord&amp;)&gt; visitor)</span></span></span><br><span class="line"><span class="function">    <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">auto</span>* payloads = payloads_.<span class="built_in">get</span>()) &#123;</span><br><span class="line">    <span class="type">bool</span> in_reverse =</span><br><span class="line">        payloads-&gt;<span class="built_in">size</span>() &gt; <span class="number">1</span> &amp;&amp; <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(payloads) % <span class="number">13</span> &gt; <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> index = <span class="number">0</span>; index &lt; payloads-&gt;<span class="built_in">size</span>(); ++index) &#123;</span><br><span class="line">      <span class="type">const</span> <span class="keyword">auto</span>&amp; elem =</span><br><span class="line">          (*payloads)[in_reverse ? payloads-&gt;<span class="built_in">size</span>() - <span class="number">1</span> - index : index];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NDEBUG</span></span><br><span class="line">      <span class="built_in">visitor</span>(elem.type_url, elem.payload);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="comment">// In debug mode invalidate the type url to prevent users from relying on</span></span><br><span class="line">      <span class="comment">// this string lifetime.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// NOLINTNEXTLINE intentional extra conversion to force temporary.</span></span><br><span class="line">      <span class="built_in">visitor</span>(std::<span class="built_in">string</span>(elem.type_url), elem.payload);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// NDEBUG</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå¯ä»¥æŠŠ <code>absl::FunctionRef&lt;&gt;</code> å½“ä½œ <code>const std::function&lt;&gt;&amp;</code> ç­‰ä»·ç‰©ï¼Œè¿™æ˜¯ absl è‡ªå·±åšçš„ä¸€ä¸ªä¼˜åŒ–</p>
<p>å…¶æ¬¡å‡½æ•° contract ä¸­è¯´å¦‚æœæœ‰å¤šä¸ª payloadsï¼Œé‚£ä¹ˆä»–ä»¬çš„éå†é¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œå¹¶ä¸”ä¸ºäº†è´¯å½»è¿™ä¸ªè¡Œä¸ºï¼Œéå†çš„æ—¶å€™åšäº†ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„æ¦‚ç‡å¤„ç†ï¼šæœ‰ä¸€å®šæ¦‚ç‡æ˜¯åå‘éå†çš„</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(payloads) % <span class="number">13</span> &gt; <span class="number">6</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª trick æ„Ÿè§‰å¯ä»¥å€Ÿé‰´ä¸€ä¸‹ï¼Œå¼€é”€æ¯”ç”¨ rand ä¼šä½å¾ˆå¤š</p>
</div><div class="tags"><a href="/tags/cpp/"><i class="fa fa-tag"></i>cpp</a><a href="/tags/abseil/"><i class="fa fa-tag"></i>abseil</a><a href="/tags/absl-Status/"><i class="fa fa-tag"></i>absl::Status</a></div><div class="post-nav"><a class="pre" href="/2024/05/13/weekly-2024-may-2/">ä¸€å‘¨æ‚è®° in Week 2 May 2024</a><a class="next" href="/2024/05/06/weekly-2024-may-1/">ä¸€å‘¨æ‚è®° in Week 1 May 2024</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">é˜…è¯»è¯„è®ºï¼ˆè¯·ç¡®ä¿ Disqus å¯ä»¥æ­£å¸¸åŠ è½½ï¼‰</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://kingsamchen.github.io/2024/05/12/src-study-abseil-status-status/';
    this.page.identifier = '2024/05/12/src-study-abseil-status-status/';
    this.page.title = 'abseil status/status æºç åˆ†æ';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//kingsamchen-github-io.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//kingsamchen-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://kingsamchen-github-io.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://kingsamchen.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CODE-LIFE/">CODE-LIFE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PROGRAMMING/">PROGRAMMING</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/07/14/weekly-2025-july-2/">ä¸€å‘¨æ‚è®° in Week 2 July 2025</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/07/07/weekly-2025-july-1/">ä¸€å‘¨æ‚è®° in Week 1 July 2025</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/30/weekly-2025-june-4/">ä¸€å‘¨æ‚è®° in Week 4 June 2025</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/23/weekly-2025-june-3/">ä¸€å‘¨æ‚è®° in Week 3 June 2025</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/16/weekly-2025-june-2/">ä¸€å‘¨æ‚è®° in Week 2 June 2025</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/10/display-proxy-status-on-shell-prompt/">Display Proxy Status on Shell Prompt</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/09/weekly-2025-june-1/">ä¸€å‘¨æ‚è®° in Week 1 June 2025</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/03/weekly-2025-may-5/">ä¸€å‘¨æ‚è®° in Week 5 May 2025</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/05/31/cxx-20-date-time-samples/">C++20 Calendar Datetime Quick Intro</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/05/25/weekly-2025-may-4/">ä¸€å‘¨æ‚è®° in Week 4 May 2025</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/rant/" style="font-size: 15px;">rant</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/cpp/" style="font-size: 15px;">cpp</a> <a href="/tags/memory-fence/" style="font-size: 15px;">memory fence</a> <a href="/tags/memory-ordering/" style="font-size: 15px;">memory ordering</a> <a href="/tags/Windows/" style="font-size: 15px;">Windows</a> <a href="/tags/multiple-instance/" style="font-size: 15px;">multiple instance</a> <a href="/tags/crash/" style="font-size: 15px;">crash</a> <a href="/tags/breakpad/" style="font-size: 15px;">breakpad</a> <a href="/tags/exception/" style="font-size: 15px;">exception</a> <a href="/tags/c/" style="font-size: 15px;">c++</a> <a href="/tags/enum/" style="font-size: 15px;">enum</a> <a href="/tags/flag/" style="font-size: 15px;">flag</a> <a href="/tags/bitwise%EF%BC%8C-SFINAE/" style="font-size: 15px;">bitwiseï¼Œ SFINAE</a> <a href="/tags/KBase/" style="font-size: 15px;">KBase</a> <a href="/tags/command-line/" style="font-size: 15px;">command-line</a> <a href="/tags/abstraction/" style="font-size: 15px;">abstraction</a> <a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/design/" style="font-size: 15px;">design</a> <a href="/tags/environment/" style="font-size: 15px;">environment</a> <a href="/tags/anvil/" style="font-size: 15px;">anvil</a> <a href="/tags/cmake/" style="font-size: 15px;">cmake</a> <a href="/tags/project-management/" style="font-size: 15px;">project management</a> <a href="/tags/C-17/" style="font-size: 15px;">C++ 17</a> <a href="/tags/string-view/" style="font-size: 15px;">string_view</a> <a href="/tags/tokenizer/" style="font-size: 15px;">tokenizer</a> <a href="/tags/atoi/" style="font-size: 15px;">atoi</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/asio/" style="font-size: 15px;">asio</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/cfs/" style="font-size: 15px;">cfs</a> <a href="/tags/non-capturing-lambda/" style="font-size: 15px;">non-capturing lambda</a> <a href="/tags/function-pointer/" style="font-size: 15px;">function pointer</a> <a href="/tags/obs-studio/" style="font-size: 15px;">obs-studio</a> <a href="/tags/inno-setup/" style="font-size: 15px;">inno setup</a> <a href="/tags/installer/" style="font-size: 15px;">installer</a> <a href="/tags/%E6%A2%AF%E5%AD%90/" style="font-size: 15px;">æ¢¯å­</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/trojan/" style="font-size: 15px;">trojan</a> <a href="/tags/socat/" style="font-size: 15px;">socat</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Unix/" style="font-size: 15px;">Unix</a> <a href="/tags/signal/" style="font-size: 15px;">signal</a> <a href="/tags/signalfd/" style="font-size: 15px;">signalfd</a> <a href="/tags/self-pipe-trick/" style="font-size: 15px;">self-pipe trick</a> <a href="/tags/cant/" style="font-size: 15px;">cant</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/HandlerThread/" style="font-size: 15px;">HandlerThread</a> <a href="/tags/Looper/" style="font-size: 15px;">Looper</a> <a href="/tags/Handler/" style="font-size: 15px;">Handler</a> <a href="/tags/MessageLoop/" style="font-size: 15px;">MessageLoop</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/proxy/" style="font-size: 15px;">proxy</a> <a href="/tags/thread-pool/" style="font-size: 15px;">thread-pool</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/urlfetcher/" style="font-size: 15px;">urlfetcher</a> <a href="/tags/wireshark/" style="font-size: 15px;">wireshark</a> <a href="/tags/localhost/" style="font-size: 15px;">localhost</a> <a href="/tags/SFINAE/" style="font-size: 15px;">SFINAE</a> <a href="/tags/template/" style="font-size: 15px;">template</a> <a href="/tags/source-internals/" style="font-size: 15px;">source internals</a> <a href="/tags/message-loop/" style="font-size: 15px;">message-loop</a> <a href="/tags/shared-ptr/" style="font-size: 15px;">shared_ptr</a> <a href="/tags/type-injection/" style="font-size: 15px;">type injection</a> <a href="/tags/visual-studio/" style="font-size: 15px;">visual studio</a> <a href="/tags/libx264/" style="font-size: 15px;">libx264</a> <a href="/tags/vcpkg/" style="font-size: 15px;">vcpkg</a> <a href="/tags/tag-dispatching/" style="font-size: 15px;">tag dispatching</a> <a href="/tags/shared-ptr-internals/" style="font-size: 15px;">shared_ptr-internals</a> <a href="/tags/source-code-study/" style="font-size: 15px;">source-code-study</a> <a href="/tags/weak-ptr/" style="font-size: 15px;">weak_ptr</a> <a href="/tags/base-lib/" style="font-size: 15px;">base lib</a> <a href="/tags/boost/" style="font-size: 15px;">boost</a> <a href="/tags/datetime/" style="font-size: 15px;">datetime</a> <a href="/tags/chrono/" style="font-size: 15px;">chrono</a> <a href="/tags/libstdc/" style="font-size: 15px;">libstdc++</a> <a href="/tags/gcc/" style="font-size: 15px;">gcc</a> <a href="/tags/clang/" style="font-size: 15px;">clang</a> <a href="/tags/sfinae/" style="font-size: 15px;">sfinae</a> <a href="/tags/buddy-allocator/" style="font-size: 15px;">buddy-allocator</a> <a href="/tags/algorithms/" style="font-size: 15px;">algorithms</a> <a href="/tags/google-breakpad/" style="font-size: 15px;">google-breakpad</a> <a href="/tags/invalid-paramter/" style="font-size: 15px;">invalid paramter</a> <a href="/tags/operator/" style="font-size: 15px;">operator[]</a> <a href="/tags/owner-semantics/" style="font-size: 15px;">owner semantics</a> <a href="/tags/view-semantics/" style="font-size: 15px;">view semantics</a> <a href="/tags/error-handling/" style="font-size: 15px;">error handling</a> <a href="/tags/msvc/" style="font-size: 15px;">msvc</a> <a href="/tags/ebo/" style="font-size: 15px;">ebo</a> <a href="/tags/multiple-inheritance/" style="font-size: 15px;">multiple inheritance</a> <a href="/tags/haskell/" style="font-size: 15px;">haskell</a> <a href="/tags/infix-operator/" style="font-size: 15px;">infix operator</a> <a href="/tags/Visual-Studio/" style="font-size: 15px;">Visual Studio</a> <a href="/tags/debugger/" style="font-size: 15px;">debugger</a> <a href="/tags/UTF-8/" style="font-size: 15px;">UTF-8</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/mint/" style="font-size: 15px;">mint</a> <a href="/tags/%E7%A3%81%E7%9B%98/" style="font-size: 15px;">ç£ç›˜</a> <a href="/tags/%E6%89%A9%E5%AE%B9/" style="font-size: 15px;">æ‰©å®¹</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://www.daozhihun.com/" title="åˆ€ä¹‹é­‚ | å¤§æœ¨è€å¸ˆæˆé•¿æ—¥è®°" target="_blank">åˆ€ä¹‹é­‚ | å¤§æœ¨è€å¸ˆæˆé•¿æ—¥è®°</a><ul></ul><a href="https://runzhen.github.io/" title="ç®¡ç†å‘˜ | ç¡…è°·è°ˆæ’¸ç®¡" target="_blank">ç®¡ç†å‘˜ | ç¡…è°·è°ˆæ’¸ç®¡</a><ul></ul><a href="https://blog.chichou.me/" title="ChiChou | é¦–å¸­å®‰å…¨åœ°çƒä»ªåˆ‡å›¾æ€»å¥¸" target="_blank">ChiChou | é¦–å¸­å®‰å…¨åœ°çƒä»ªåˆ‡å›¾æ€»å¥¸</a><ul></ul><a href="https://fleurer.github.io/" title="Fleurer-lee | Få”çš„è¯»ä¹¦ç¬”è®°ï¼ˆå¤§é‡å¹²è´§ï¼‰" target="_blank">Fleurer-lee | Få”çš„è¯»ä¹¦ç¬”è®°ï¼ˆå¤§é‡å¹²è´§ï¼‰</a><ul></ul><a href="https://vizee.org/" title="Vizee | å³å°†èµ°ä¸Šäººç”Ÿå·…å³°æ¨èè‰çš„ç« æ€»" target="_blank">Vizee | å³å°†èµ°ä¸Šäººç”Ÿå·…å³°æ¨èè‰çš„ç« æ€»</a><ul></ul><a href="https://blog.thecjw.me/" title="TheCJW | çˆ±å¼¹æ£‰èŠ±çš„å°ä¼Ÿ" target="_blank">TheCJW | çˆ±å¼¹æ£‰èŠ±çš„å°ä¼Ÿ</a><ul></ul><a href="https://newbiecoder.0ginr.com/blog/" title="Newbie Coder | èŒèŒå“’çš„ç‚‰å­" target="_blank">Newbie Coder | èŒèŒå“’çš„ç‚‰å­</a><ul></ul><a href="https://frankpie.github.io/" title="è£´è‰è“ | æ„¤æ€’çš„è€å¸æœº" target="_blank">è£´è‰è“ | æ„¤æ€’çš„è€å¸æœº</a><ul></ul><a href="https://beanbee.me/" title="é™ˆè€å¸ˆ | Beanbee.Max" target="_blank">é™ˆè€å¸ˆ | Beanbee.Max</a><ul></ul><a href="https://sunus.me/" title="Sunus | æå¸ˆå‚…é£Ÿå“å‚CEO" target="_blank">Sunus | æå¸ˆå‚…é£Ÿå“å‚CEO</a><ul></ul><a href="http://www.tolower.net/" title="Lower | å–Šå¤§æœ¨å¤§å“¥çš„å°å¼Ÿ" target="_blank">Lower | å–Šå¤§æœ¨å¤§å“¥çš„å°å¼Ÿ</a><ul></ul><a href="http://mrljdx.com/" title="Mrljdx | å¤§ä¿å¥è€å¸æœº" target="_blank">Mrljdx | å¤§ä¿å¥è€å¸æœº</a><ul></ul><a href="https://www.mydavelv.net/" title="Davelv | æ±Ÿæ¹–äººç§°å¤§å°¾é©´" target="_blank">Davelv | æ±Ÿæ¹–äººç§°å¤§å°¾é©´</a></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//kingsamchen-github-io.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2025 <a href="/." rel="nofollow">KCçš„åºŸå¢Ÿå †.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>