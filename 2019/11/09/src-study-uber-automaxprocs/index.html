<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Gone with the ruins"><title>uber automaxprocs 源码分析 | KC的废墟堆</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">uber automaxprocs 源码分析</h1><a id="logo" href="/.">KC的废墟堆</a><p class="description">Will you serve in Heaven, or rule in Hell</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/source-code-reading/"><i class="fa fa-archive"> 源码分析</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">uber automaxprocs 源码分析</h1><div class="post-meta">2019-11-09<span> | </span><span class="category"><a href="/categories/PROGRAMMING/">PROGRAMMING</a></span></div><a class="disqus-comment-count" data-disqus-identifier="2019/11/09/src-study-uber-automaxprocs/" href="/2019/11/09/src-study-uber-automaxprocs/#disqus_thread"></a><div class="post-content"><p>最近直播内部的 golang 服务都使用了 uber 出品的 automaxprocs 这个库。</p>
<p>据伟大的 @ice 马总说，这个库解决了一个困扰B站整个golang（container）技术栈一年多的问题。</p>
<p>出于好奇这个库到底做了什么 magic，能够解决这个持续了一年多的 pain in the ass，抽了一点时间，稍微翻了一下库的源代码，记录如下。</p>
<h1 id="automaxprocs-解决了什么问题"><a href="#automaxprocs-解决了什么问题" class="headerlink" title="automaxprocs 解决了什么问题"></a>automaxprocs 解决了什么问题</h1><p>线上容器里的服务通常都对 CPU 资源做了限制，例如默认的 4C。</p>
<p>但是在容器里通过 <code>lscpu</code> 仍然能看到宿主机的所有 CPU 核心：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">rchitecture:          x86_64</span><br><span class="line">CPU op-mode(s):        32-bit, 64-bit</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                48</span><br><span class="line">On-line CPU(s) list:   0-47</span><br><span class="line">Thread(s) per core:    2</span><br><span class="line">Core(s) per socket:    12</span><br><span class="line">Socket(s):             2</span><br><span class="line">NUMA node(s):          2</span><br><span class="line">Vendor ID:             GenuineIntel</span><br><span class="line">CPU family:            6</span><br><span class="line">Model:                 79</span><br><span class="line">Model name:            Intel(R) Xeon(R) CPU E5-2650 v4 @ 2.20GHz</span><br><span class="line">Stepping:              1</span><br></pre></td></tr></table></figure>

<p>这就导致 golang 服务默认会拿宿主机的 CPU 核心数来调用 <code>runtime.GOMAXPROCS()</code>，导致 P 数量远远大于可用的 CPU 核心，引起频繁上下文切换，影响高负载情况下的服务性能。</p>
<span id="more"></span>
<p>automaxprocs 能够正确识别容器允许使用的核心数，合理的设置 go processor，避免这个问题。</p>
<h1 id="automaxprocs-源码分析"><a href="#automaxprocs-源码分析" class="headerlink" title="automaxprocs 源码分析"></a>automaxprocs 源码分析</h1><h2 id="Grand-Tour"><a href="#Grand-Tour" class="headerlink" title="Grand Tour"></a>Grand Tour</h2><p>包级别的 <code>init()</code> 函数（代码位置在 <code>automaxprocs/automaxprocs.go</code>）实现了导入这个包即可产生作用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	maxprocs.Set(maxprocs.Logger(log.Printf))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心函数就是 <code>maxprocs.Set()</code>；这个函数会从当前的 cgroups 里获取设置的 CPU quota，然后转换为合适的 <code>GOMAXPROCS</code>。</p>
<p>核心逻辑（略去一些细节）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> config <span class="keyword">struct</span> &#123;</span><br><span class="line">	printf        <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span></span>                      <span class="comment">// logger</span></span><br><span class="line">	procs         <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">int</span>)</span></span> (<span class="type">int</span>, iruntime.CPUQuotaStatus, <span class="type">error</span>)</span><br><span class="line">	minGOMAXPROCS <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// within func Set()</span></span><br><span class="line"></span><br><span class="line">cfg := &amp;config&#123;</span><br><span class="line">    procs:         iruntime.CPUQuotaToGOMAXPROCS,</span><br><span class="line">    minGOMAXPROCS: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">maxProcs, status, err := cfg.procs(cfg.minGOMAXPROCS)</span><br><span class="line"></span><br><span class="line">runtime.GOMAXPROCS(maxProcs)</span><br></pre></td></tr></table></figure>

<p>可以看出主要的工作都在 <code>iruntime.CPUQuotaToGOMAXPROCS()</code> 里完成。</p>
<p>至于 <code>minGOMAXPROCS</code> 的作用</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxProcs = max(cpu_quota, minGOMAXPROCS)</span><br></pre></td></tr></table></figure>


<p>避免外部 cpu quota 设置的过小。</p>
<h2 id="获取进程的-cgroup-信息"><a href="#获取进程的-cgroup-信息" class="headerlink" title="获取进程的 cgroup 信息"></a>获取进程的 cgroup 信息</h2><p>核心函数之一的 <code>parseCGroupSubsystems()</code> 可以通过解析 <code>/proc/$pid/cgroup</code> 文件，返回这个进程的 cgroup subsystem table，对应的数据结构是：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// key 其实就是 subsystem</span></span><br><span class="line">subsystems := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]*CGroupSubsys)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CGroupSubsys <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID         <span class="type">int</span></span><br><span class="line">	Subsystems []<span class="type">string</span></span><br><span class="line">	Name       <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里看一下 <code>/proc/$pid/cgroup</code> 的样子（从线上找了一个服务）：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">10:pids:/kubepods/burstable/pod5627f0a1-010c-11ea-90fe-d0946603da2e/f090bf4f93ec9d1f4f12b56b2ed40268c1e1c3a0bb8a92799dd99caeca80147d</span><br><span class="line">9:perf_event:/kubepods/burstable/pod5627f0a1-010c-11ea-90fe-d0946603da2e/f090bf4f93ec9d1f4f12b56b2ed40268c1e1c3a0bb8a92799dd99caeca80147d</span><br><span class="line">8:net_cls,net_prio:/kubepods/burstable/pod5627f0a1-010c-11ea-90fe-d0946603da2e/f090bf4f93ec9d1f4f12b56b2ed40268c1e1c3a0bb8a92799dd99caeca80147d</span><br><span class="line">7:freezer:/kubepods/burstable/pod5627f0a1-010c-11ea-90fe-d0946603da2e/f090bf4f93ec9d1f4f12b56b2ed40268c1e1c3a0bb8a92799dd99caeca80147d</span><br><span class="line">6:devices:/kubepods/burstable/pod5627f0a1-010c-11ea-90fe-d0946603da2e/f090bf4f93ec9d1f4f12b56b2ed40268c1e1c3a0bb8a92799dd99caeca80147d</span><br><span class="line">5:memory:/kubepods/burstable/pod5627f0a1-010c-11ea-90fe-d0946603da2e/f090bf4f93ec9d1f4f12b56b2ed40268c1e1c3a0bb8a92799dd99caeca80147d</span><br><span class="line">4:blkio:/kubepods/burstable/pod5627f0a1-010c-11ea-90fe-d0946603da2e/f090bf4f93ec9d1f4f12b56b2ed40268c1e1c3a0bb8a92799dd99caeca80147d</span><br><span class="line">--&gt; 3:cpu,cpuacct:/kubepods/burstable/pod5627f0a1-010c-11ea-90fe-d0946603da2e/f090bf4f93ec9d1f4f12b56b2ed40268c1e1c3a0bb8a92799dd99caeca80147d</span><br><span class="line">2:cpuset:/kubepods/burstable/pod5627f0a1-010c-11ea-90fe-d0946603da2e/f090bf4f93ec9d1f4f12b56b2ed40268c1e1c3a0bb8a92799dd99caeca80147d</span><br><span class="line">1:name=systemd:/kubepods/burstable/pod5627f0a1-010c-11ea-90fe-d0946603da2e/f090bf4f93ec9d1f4f12b56b2ed40268c1e1c3a0bb8a92799dd99caeca80147d</span><br></pre></td></tr></table></figure>

<p>每行都是一条记录，记录的每个 field 之间用 <code>:</code> 分割，从左至右分别是：</p>
<ul>
<li>id</li>
<li>subsystems，多个 subsystem 之间用 <code>,</code> 分隔</li>
<li>pathname</li>
</ul>
<p>这里的目标是包含 <code>cpu</code> 这个 subsystem 的这条记录；其他的记录其实无关紧要。</p>
<p>同时注意一下 <code>pathname</code> 这个字段，代表进程所属的 cgroup hierarchy 的路径，并且一个相对于 cgroup hierarchy 的 mount point 的一个相对路径。</p>
<p>BTW：这里能看到一条记录可能有多个 subsystem，所以前面的 table 最后会出现多个 subsystem key 指向的其实是同一个 <code>CGroupSubsys</code> 实例。</p>
<h2 id="获取进程的-mountinfo"><a href="#获取进程的-mountinfo" class="headerlink" title="获取进程的 mountinfo"></a>获取进程的 mountinfo</h2><p>类似的，核心函数 <code>parseMountInfo()</code> 会打开进程的 <code>mountinfo</code> 文件，然后将每一行记录解析成对应的 <code>MountInfo</code> 结构</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MountPoint <span class="keyword">struct</span> &#123;</span><br><span class="line">	MountID        <span class="type">int</span></span><br><span class="line">	ParentID       <span class="type">int</span></span><br><span class="line">	DeviceID       <span class="type">string</span></span><br><span class="line">	Root           <span class="type">string</span></span><br><span class="line">	MountPoint     <span class="type">string</span></span><br><span class="line">	Options        []<span class="type">string</span></span><br><span class="line">	OptionalFields []<span class="type">string</span></span><br><span class="line">	FSType         <span class="type">string</span></span><br><span class="line">	MountSource    <span class="type">string</span></span><br><span class="line">	SuperOptions   []<span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看一下一个示例 <code>mountinfo</code> 文件内容</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@data-guru-129126-b9bf4d97-rrd65:/# cat /proc/24/mountinfo | grep cgroup</span><br><span class="line">1879 1878 0:147 / /sys/fs/cgroup ro,nosuid,nodev,noexec,relatime - tmpfs tmpfs rw,mode=755</span><br><span class="line">1880 1879 0:23 /kubepods/burstable/pod7462dcc7-010a-11ea-90fe-d0946603da2e/85ca96fbb5ee9855ce56da4731bf346786f62b6199a58f66edfb0b7e96b73854 /sys/fs/cgroup/systemd ro,nosuid,nodev,noexec,relatime master:10 - cgroup cgroup rw,xattr,release_agent=/lib/systemd/systemd-cgroups-agent,name=systemd</span><br><span class="line">1881 1879 0:25 /kubepods/burstable/pod7462dcc7-010a-11ea-90fe-d0946603da2e/85ca96fbb5ee9855ce56da4731bf346786f62b6199a58f66edfb0b7e96b73854 /sys/fs/cgroup/cpuset ro,nosuid,nodev,noexec,relatime master:13 - cgroup cgroup rw,cpuset</span><br><span class="line">--&gt; 1882 1879 0:26 /kubepods/burstable/pod7462dcc7-010a-11ea-90fe-d0946603da2e/85ca96fbb5ee9855ce56da4731bf346786f62b6199a58f66edfb0b7e96b73854 /sys/fs/cgroup/cpu,cpuacct ro,nosuid,nodev,noexec,relatime master:14 - cgroup cgroup rw,cpu,cpuacct</span><br><span class="line">1884 1879 0:27 /kubepods/burstable/pod7462dcc7-010a-11ea-90fe-d0946603da2e/85ca96fbb5ee9855ce56da4731bf346786f62b6199a58f66edfb0b7e96b73854 /sys/fs/cgroup/blkio ro,nosuid,nodev,noexec,relatime master:15 - cgroup cgroup rw,blkio</span><br><span class="line">1885 1879 0:28 /kubepods/burstable/pod7462dcc7-010a-11ea-90fe-d0946603da2e/85ca96fbb5ee9855ce56da4731bf346786f62b6199a58f66edfb0b7e96b73854 /sys/fs/cgroup/memory ro,nosuid,nodev,noexec,relatime master:16 - cgroup cgroup rw,memory</span><br><span class="line">1886 1879 0:29 /kubepods/burstable/pod7462dcc7-010a-11ea-90fe-d0946603da2e/85ca96fbb5ee9855ce56da4731bf346786f62b6199a58f66edfb0b7e96b73854 /sys/fs/cgroup/devices ro,nosuid,nodev,noexec,relatime master:17 - cgroup cgroup rw,devices</span><br><span class="line">1887 1879 0:30 /kubepods/burstable/pod7462dcc7-010a-11ea-90fe-d0946603da2e/85ca96fbb5ee9855ce56da4731bf346786f62b6199a58f66edfb0b7e96b73854 /sys/fs/cgroup/freezer ro,nosuid,nodev,noexec,relatime master:18 - cgroup cgroup rw,freezer</span><br><span class="line">1888 1879 0:31 /kubepods/burstable/pod7462dcc7-010a-11ea-90fe-d0946603da2e/85ca96fbb5ee9855ce56da4731bf346786f62b6199a58f66edfb0b7e96b73854 /sys/fs/cgroup/net_cls,net_prio ro,nosuid,nodev,noexec,relatime master:19 - cgroup cgroup rw,net_cls,net_prio</span><br><span class="line">1889 1879 0:32 /kubepods/burstable/pod7462dcc7-010a-11ea-90fe-d0946603da2e/85ca96fbb5ee9855ce56da4731bf346786f62b6199a58f66edfb0b7e96b73854 /sys/fs/cgroup/perf_event ro,nosuid,nodev,noexec,relatime master:20 - cgroup cgroup rw,perf_event</span><br><span class="line">1890 1879 0:33 /kubepods/burstable/pod7462dcc7-010a-11ea-90fe-d0946603da2e/85ca96fbb5ee9855ce56da4731bf346786f62b6199a58f66edfb0b7e96b73854 /sys/fs/cgroup/pids ro,nosuid,nodev,noexec,relatime master:21 - cgroup cgroup rw,pids</span><br></pre></td></tr></table></figure>

<p>每条记录的字段用空格分隔，字段 <code>-</code> 表示后面都是 options</p>
<p>共有三个字段需要我们关心：</p>
<ul>
<li>索引为3的字段；组成当前挂载点根路径的文件系统的路径，对应 <code>MountInfo.Root</code></li>
<li>索引为4的字段；当前挂载点相对于进程根目录的路径，对应 <code>MountInfo.MountPoint</code></li>
<li><code>-</code> 字段之后的第一个字段，代表 filesystem type，对应 <code>MountInfo.FsType</code>；我们其实只需要 <code>cgroup</code>。</li>
<li>上面 fstype 字段之后的第二个字段，是 subsystems，subsystem之间用,分割；这里我们其实需要的是包含 <code>cpu</code> 的这个 subsystem</li>
</ul>
<h2 id="找到目标-cgroup-path"><a href="#找到目标-cgroup-path" class="headerlink" title="找到目标 cgroup path"></a>找到目标 cgroup path</h2><p>有了前两步之后，就可以找到进程对应的 <code>cpu</code> 这个 subsystem 的 CGroup path。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CGroup represents the data structure for a Linux control group.</span></span><br><span class="line"><span class="keyword">type</span> CGroup <span class="keyword">struct</span> &#123;</span><br><span class="line">	path <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分操作在 lambda 函数 <code>newMountPoint()</code> 中。</p>
<p>总结起来就是：</p>
<ol>
<li>在 mountinfo 文件中找到 <code>fstype = cgroup &amp;&amp; subsystems.contains(cpu)</code> 的记录，分离出 <code>root</code> 和 <code>mount-point</code>。</li>
<li>在 cgroup 文件中找到 <code>subsystems.contains(cpu)</code> 的记录，分理出 pathname</li>
<li><code>cgroupPath = Join(mount_point, relative(root, pathname))</code><br><code>relative()</code> 函数返回 pathname 相对于 root 的相对路径</li>
</ol>
<p>BTW：实践中发现 <code>root</code> 和 <code>pathname</code> 基本一致，这样返回的相对路径就是 <code>.</code>；最后组合的最终路径都是 <code>/sys/fs/cgroup/cpu</code></p>
<p>不过考虑到不同发行版甚至不同版本的 docker &#x2F; k8s 行为可能存在不一致，所以最具有移植性还是上面的做法。</p>
<h2 id="计算-cpu-配额"><a href="#计算-cpu-配额" class="headerlink" title="计算 cpu 配额"></a>计算 cpu 配额</h2><p>有了前面的目录路径之后，该目录下的：</p>
<ul>
<li><code>cfs.cpu_period_us</code> 文件记录了调度周期，单位是 us；默认值一般是 100’000，即 100 ms</li>
<li><code>cfs.cpu_quota_us</code> 记录了每个调度周期进程允许使用 cpu 的量，单位也是 us。<br>值为 -1 表示无限制；对于 4C 的容器，这个值一般是 400’000</li>
</ul>
<blockquote>
<p>Aside：这两个值限制的是进程使用 cpu 的时间。<br>上述设置下表示：每 100ms 的调度周期内，该进程可以使用 400ms 的 cpu 时间，所以看起来的效果是可以使用4个CPU核心<br>更详细的内容请参考 Linux kernel 的文档：<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/scheduler/sched-bwc.txt">CFS Bandwidth Control</a></p>
</blockquote>
<p>quota 和 period 的比值就是 docker 为容器设置的 CPU 核数配置。</p>
<p>这个值也是 automaxprocs 为 <code>runtime.GOMAXPROCS()</code> 设置的值。</p>
<p>这部分逻辑对应库函数：<code>CGoups.CPUQuota()</code></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>容器技术（docker）通过 Linux kernel 提供的 cgroups 机制来实现资源隔离和限制，但是这种限制有时候会出现反直觉的结果。</p>
<p>上面的分析过程看，虽然这个库做的事情比较简单，但是要注意的是，我们是通过逆向工程（由果推因）来分析的这个问题。</p>
<p>如果需要从正面解决（执因索果），那么就需要对 1）容器实现细节 2）linux 内核中 cgroups 的实现细节 有很深的了解。</p>
<p>这恐怕也是过了一年多才找到解决方案，而且最后还是直接使用别人的solution的原因。</p>
<h1 id="彩蛋"><a href="#彩蛋" class="headerlink" title="彩蛋"></a>彩蛋</h1><h2 id="0x0"><a href="#0x0" class="headerlink" title="0x0"></a>0x0</h2><p>事实上，automaxprocs 仅针对于使用 CFS 调度策略的实例。</p>
<p>CFS 调度测类只限制进程的运行配额，不设置 processor affinity。所以在 4C 的限制下，理论上 G-P-M 调度模型下的 M 可以运行在任意物理核心上</p>
<p>查看 <code>/sys/fs/cgroup/cpuset/cpuset.cpus</code> 这个文件可以发现没有做任何物理核心上的限制。</p>
<p>docker 创建容器时可以使用 <code>--cpus=x</code> 来实现。</p>
<h2 id="0x1"><a href="#0x1" class="headerlink" title="0x1"></a>0x1</h2><p>对于<strong>只</strong>使用 cpuset 策略的容器来说，其实没必要使用这个库。</p>
<p>因为 cpuset 直接设置了容器的 processor affinity，然后神奇的是，golang 的 <code>runtime.NumCores()</code> 获取的核心数是考虑过 processor affinity 的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @ /usr/local/go/src/runtime/os_linux.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getproccount</span><span class="params">()</span></span> <span class="type">int32</span> &#123;</span><br><span class="line">	<span class="comment">// This buffer is huge (8 kB) but we are on the system stack</span></span><br><span class="line">	<span class="comment">// and there should be plenty of space (64 kB).</span></span><br><span class="line">	<span class="comment">// Also this is a leaf, so we&#x27;re not holding up the memory for long.</span></span><br><span class="line">	<span class="comment">// See golang.org/issue/11823.</span></span><br><span class="line">	<span class="comment">// The suggested behavior here is to keep trying with ever-larger</span></span><br><span class="line">	<span class="comment">// buffers, but we don&#x27;t have a dynamic memory allocator at the</span></span><br><span class="line">	<span class="comment">// moment, so that&#x27;s a bit tricky and seems like overkill.</span></span><br><span class="line">	<span class="keyword">const</span> maxCPUs = <span class="number">64</span> * <span class="number">1024</span></span><br><span class="line">	<span class="keyword">var</span> buf [maxCPUs / <span class="number">8</span>]<span class="type">byte</span></span><br><span class="line">	r := sched_getaffinity(<span class="number">0</span>, unsafe.Sizeof(buf), &amp;buf[<span class="number">0</span>])</span><br><span class="line">	<span class="keyword">if</span> r &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	n := <span class="type">int32</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> buf[:r] &#123;</span><br><span class="line">		<span class="keyword">for</span> v != <span class="number">0</span> &#123;</span><br><span class="line">			n += <span class="type">int32</span>(v &amp; <span class="number">1</span>)</span><br><span class="line">			v &gt;&gt;= <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">		n = <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sched_getaffinity()</code> 其实是一个 <a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man2/sched_setaffinity.2.html">linux syscall</a></p>
<p>注：虽然 <code>runtime.NumCores()</code> 是根据亲缘性获取的，但是这个值第一次初始化之后与就不再变化了，即使后面 processor affinity 在运行过程中被更改了。。。</p>
<p>所以有人提了一个相关的 issue：<a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/11609">runtime: NumCPU does not change when process affinity changes</a></p>
</div><div class="tags"><a href="/tags/golang/"><i class="fa fa-tag"></i>golang</a><a href="/tags/automaxprocs/"><i class="fa fa-tag"></i>automaxprocs</a></div><div class="post-nav"><a class="pre" href="/2019/11/24/auto-cfs-cores-cpp-version-of-automaxprocs/">auto-cfs-cores C++ 版 automaxprocs</a><a class="next" href="/2019/11/04/token-bucket-based-rate-limit/">一个轮子：基于 token bucket 的 rate-limit</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://kingsamchen.github.io/2019/11/09/src-study-uber-automaxprocs/';
    this.page.identifier = '2019/11/09/src-study-uber-automaxprocs/';
    this.page.title = 'uber automaxprocs 源码分析';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//kingsamchen-github-io.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//kingsamchen-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://kingsamchen-github-io.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://kingsamchen.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CODE-LIFE/">CODE-LIFE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PROGRAMMING/">PROGRAMMING</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/12/12/weekly-2022-dec-2/">一周杂记 in Week 2 Dec 2022</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/12/04/weekly-2022-dec-1/">一周杂记 in Week 1 Dec 2022</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/11/27/weekly-2022-nov-4/">一周杂记 in Week 4 Nov 2022</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/11/21/weekly-2022-nov-3/">一周杂记 in Week 3 Nov 2022</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/11/13/weekly-2022-nov-2/">一周杂记 in Week 2 Nov 2022</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/11/08/weekly-2022-nov-1/">一周杂记 in Week 1 Nov 2022</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/11/04/weekly-2022-oct-5/">一周杂记 in Week 5 Oct 2022</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/23/weekly-2022-oct-4/">一周杂记 in Week 4 Oct 2022</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/16/weekly-2022-oct-3/">一周杂记 in Week 3 Oct 2022</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/09/weekly-2022-oct-2/">一周杂记 in Week 2 Oct 2022</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/rant/" style="font-size: 15px;">rant</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/Windows/" style="font-size: 15px;">Windows</a> <a href="/tags/crash/" style="font-size: 15px;">crash</a> <a href="/tags/breakpad/" style="font-size: 15px;">breakpad</a> <a href="/tags/cpp/" style="font-size: 15px;">cpp</a> <a href="/tags/exception/" style="font-size: 15px;">exception</a> <a href="/tags/memory-fence/" style="font-size: 15px;">memory fence</a> <a href="/tags/memory-ordering/" style="font-size: 15px;">memory ordering</a> <a href="/tags/multiple-instance/" style="font-size: 15px;">multiple instance</a> <a href="/tags/c/" style="font-size: 15px;">c++</a> <a href="/tags/enum/" style="font-size: 15px;">enum</a> <a href="/tags/flag/" style="font-size: 15px;">flag</a> <a href="/tags/bitwise%EF%BC%8C-SFINAE/" style="font-size: 15px;">bitwise， SFINAE</a> <a href="/tags/KBase/" style="font-size: 15px;">KBase</a> <a href="/tags/command-line/" style="font-size: 15px;">command-line</a> <a href="/tags/abstraction/" style="font-size: 15px;">abstraction</a> <a href="/tags/%E6%A2%AF%E5%AD%90/" style="font-size: 15px;">梯子</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/trojan/" style="font-size: 15px;">trojan</a> <a href="/tags/socat/" style="font-size: 15px;">socat</a> <a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/design/" style="font-size: 15px;">design</a> <a href="/tags/environment/" style="font-size: 15px;">environment</a> <a href="/tags/buddy-allocator/" style="font-size: 15px;">buddy-allocator</a> <a href="/tags/algorithms/" style="font-size: 15px;">algorithms</a> <a href="/tags/C-17/" style="font-size: 15px;">C++ 17</a> <a href="/tags/string-view/" style="font-size: 15px;">string_view</a> <a href="/tags/tokenizer/" style="font-size: 15px;">tokenizer</a> <a href="/tags/asio/" style="font-size: 15px;">asio</a> <a href="/tags/cmake/" style="font-size: 15px;">cmake</a> <a href="/tags/anvil/" style="font-size: 15px;">anvil</a> <a href="/tags/project-management/" style="font-size: 15px;">project management</a> <a href="/tags/atoi/" style="font-size: 15px;">atoi</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/cfs/" style="font-size: 15px;">cfs</a> <a href="/tags/non-capturing-lambda/" style="font-size: 15px;">non-capturing lambda</a> <a href="/tags/function-pointer/" style="font-size: 15px;">function pointer</a> <a href="/tags/obs-studio/" style="font-size: 15px;">obs-studio</a> <a href="/tags/inno-setup/" style="font-size: 15px;">inno setup</a> <a href="/tags/installer/" style="font-size: 15px;">installer</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Unix/" style="font-size: 15px;">Unix</a> <a href="/tags/signal/" style="font-size: 15px;">signal</a> <a href="/tags/signalfd/" style="font-size: 15px;">signalfd</a> <a href="/tags/self-pipe-trick/" style="font-size: 15px;">self-pipe trick</a> <a href="/tags/cant/" style="font-size: 15px;">cant</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/HandlerThread/" style="font-size: 15px;">HandlerThread</a> <a href="/tags/Looper/" style="font-size: 15px;">Looper</a> <a href="/tags/Handler/" style="font-size: 15px;">Handler</a> <a href="/tags/MessageLoop/" style="font-size: 15px;">MessageLoop</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/proxy/" style="font-size: 15px;">proxy</a> <a href="/tags/thread-pool/" style="font-size: 15px;">thread-pool</a> <a href="/tags/chromium/" style="font-size: 15px;">chromium</a> <a href="/tags/urlfetcher/" style="font-size: 15px;">urlfetcher</a> <a href="/tags/wireshark/" style="font-size: 15px;">wireshark</a> <a href="/tags/localhost/" style="font-size: 15px;">localhost</a> <a href="/tags/source-internals/" style="font-size: 15px;">source internals</a> <a href="/tags/message-loop/" style="font-size: 15px;">message-loop</a> <a href="/tags/SFINAE/" style="font-size: 15px;">SFINAE</a> <a href="/tags/template/" style="font-size: 15px;">template</a> <a href="/tags/visual-studio/" style="font-size: 15px;">visual studio</a> <a href="/tags/libx264/" style="font-size: 15px;">libx264</a> <a href="/tags/vcpkg/" style="font-size: 15px;">vcpkg</a> <a href="/tags/shared-ptr/" style="font-size: 15px;">shared_ptr</a> <a href="/tags/type-injection/" style="font-size: 15px;">type injection</a> <a href="/tags/shared-ptr-internals/" style="font-size: 15px;">shared_ptr-internals</a> <a href="/tags/source-code-study/" style="font-size: 15px;">source-code-study</a> <a href="/tags/weak-ptr/" style="font-size: 15px;">weak_ptr</a> <a href="/tags/base-lib/" style="font-size: 15px;">base lib</a> <a href="/tags/tag-dispatching/" style="font-size: 15px;">tag dispatching</a> <a href="/tags/boost/" style="font-size: 15px;">boost</a> <a href="/tags/libstdc/" style="font-size: 15px;">libstdc++</a> <a href="/tags/gcc/" style="font-size: 15px;">gcc</a> <a href="/tags/clang/" style="font-size: 15px;">clang</a> <a href="/tags/sfinae/" style="font-size: 15px;">sfinae</a> <a href="/tags/google-breakpad/" style="font-size: 15px;">google-breakpad</a> <a href="/tags/invalid-paramter/" style="font-size: 15px;">invalid paramter</a> <a href="/tags/operator/" style="font-size: 15px;">operator[]</a> <a href="/tags/owner-semantics/" style="font-size: 15px;">owner semantics</a> <a href="/tags/view-semantics/" style="font-size: 15px;">view semantics</a> <a href="/tags/msvc/" style="font-size: 15px;">msvc</a> <a href="/tags/ebo/" style="font-size: 15px;">ebo</a> <a href="/tags/multiple-inheritance/" style="font-size: 15px;">multiple inheritance</a> <a href="/tags/Visual-Studio/" style="font-size: 15px;">Visual Studio</a> <a href="/tags/debugger/" style="font-size: 15px;">debugger</a> <a href="/tags/UTF-8/" style="font-size: 15px;">UTF-8</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/haskell/" style="font-size: 15px;">haskell</a> <a href="/tags/infix-operator/" style="font-size: 15px;">infix operator</a> <a href="/tags/error-handling/" style="font-size: 15px;">error handling</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/mint/" style="font-size: 15px;">mint</a> <a href="/tags/%E7%A3%81%E7%9B%98/" style="font-size: 15px;">磁盘</a> <a href="/tags/%E6%89%A9%E5%AE%B9/" style="font-size: 15px;">扩容</a> <a href="/tags/line-ending/" style="font-size: 15px;">line ending</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://www.daozhihun.com/" title="刀之魂 | 大木老师成长日记" target="_blank">刀之魂 | 大木老师成长日记</a><ul></ul><a href="https://blog.nlogn.cn/" title="帧哥 | 硅谷谈撸管" target="_blank">帧哥 | 硅谷谈撸管</a><ul></ul><a href="https://blog.chichou.me/" title="ChiChou | 首席安全地球仪切图总奸" target="_blank">ChiChou | 首席安全地球仪切图总奸</a><ul></ul><a href="https://fleurer.github.io/" title="Fleurer-lee | F叔的读书笔记（大量干货）" target="_blank">Fleurer-lee | F叔的读书笔记（大量干货）</a><ul></ul><a href="https://vizee.org/" title="Vizee | 即将走上人生巅峰推萝莉的章总" target="_blank">Vizee | 即将走上人生巅峰推萝莉的章总</a><ul></ul><a href="https://blog.thecjw.me/" title="TheCJW | 爱弹棉花的小伟" target="_blank">TheCJW | 爱弹棉花的小伟</a><ul></ul><a href="https://newbiecoder.0ginr.com/blog/" title="Newbie Coder | 萌萌哒的炉子" target="_blank">Newbie Coder | 萌萌哒的炉子</a><ul></ul><a href="https://frankpie.github.io/" title="裴草莓 | 愤怒的老司机" target="_blank">裴草莓 | 愤怒的老司机</a><ul></ul><a href="https://beanbee.me/" title="陈老师 | Beanbee.Max" target="_blank">陈老师 | Beanbee.Max</a><ul></ul><a href="https://sunus.me/" title="Sunus | 李师傅食品厂CEO" target="_blank">Sunus | 李师傅食品厂CEO</a><ul></ul><a href="http://www.tolower.net/" title="Lower | 喊大木大哥的小弟" target="_blank">Lower | 喊大木大哥的小弟</a><ul></ul><a href="http://mrljdx.com/" title="Mrljdx | 大保健老司机" target="_blank">Mrljdx | 大保健老司机</a><ul></ul><a href="https://www.mydavelv.net/" title="Davelv | 江湖人称大尾驴" target="_blank">Davelv | 江湖人称大尾驴</a></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//kingsamchen-github-io.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">KC的废墟堆.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>