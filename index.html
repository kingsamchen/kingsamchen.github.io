<!DOCTYPE html>
<html lang="default">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="Gone with the ruins"/>













  <link rel="alternate" href="/atom.xml" title="KC的废墟堆">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="http://kingsamchen.github.io/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />






  



  









    <title> KC的废墟堆 </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">KC的废墟堆</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/friends/">
        <li class="mobile-menu-item">
          
          
            Friends
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">KC的废墟堆</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/friends/">
            
            
              Friends
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/03/24/on-socks4a-proxy-implementation/">socks4a 协议代理</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-03-24
        </span>
        
          <div class="post-category">
            
              <a href="/categories/CODE-LIFE/">CODE-LIFE</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p>对于网络编程学习而言，尝试实现一个 proxy 是一个很好的途径。因为一个 proxy 对于 clients 来说是 server，对 remote servers 来说又是 client，一下就覆盖到了网络编程的两个大块。</p>
<p>同时，需要管理/协调两侧的连接对如何正确的处理网络连接的关闭也是一个挑战。</p>
<p>对比普通的 HTTP Proxy，socks4a proxy 作为 transport layer proxy 在协议自身上更加”干净“（不需要像 HTTP Proxy 那样解析厚重的各种 header 以及对 HTTPS 的特殊处理），也更贴近 TCP 网络编程的具体实践。</p>
<p>对比更新的 socks5，socks4a 仅支持 TCP，对 TLS 信道加密没有协议上的要求，更容易实现。</p>
<p>另，<a href="https://www.openssh.com/txt/socks4a.protocol" target="_blank" rel="noopener">socks4a</a> 协议是 <a href="https://www.openssh.com/txt/socks4.protocol" target="_blank" rel="noopener">socks4</a> 的一个补丁版，两个协议的 RFC 文本打印下来整体不超过两页 A4 纸，半个小时就能看完。</p>
<p>上周的时候我为 ezio 增加了一个 socks4a 的<a href="https://github.com/kingsamchen/ezio/tree/master/examples/socks4a" target="_blank" rel="noopener">简单实现</a>，过程中发现了 <code>TCPClient</code> 在 teardown 时存在<a href="https://github.com/kingsamchen/ezio/commit/24c1dc4d6af91f03dd748d4a3713280e71eaceef" target="_blank" rel="noopener">缺陷</a>，有概率导致连接的断开和 <code>TCPClient</code> 的析构出现 race。</p>
<p>同时还发现作为测试的 curl v7.46 （ubuntu 16.04 LTS apt 版本）在处理 HTTPS 请求时存在缺陷，会导致 client connection 过早断开，proxy 出现 RST 错误。</p>
<p>这说明拿 socks4a proxy 作为熟悉具体的语言/网络库的编程范式的例子还是非常不错的。</p>
<p>注：socks4a 协议有两个连接模式：常用的 <code>CONNECT</code> 和 <code>BIND</code>，后者是为了适应 FTP 的 <a href="https://stackoverflow.com/questions/1699145/what-is-the-difference-between-active-and-passive-ftp" target="_blank" rel="noopener">active mode</a> 而存在的，现在基本没有使用的必要，可以直接忽略。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/03/13/recommend-google-api-design-guide/">推荐 Google API Design Guide</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-03-13
        </span>
        
          <div class="post-category">
            
              <a href="/categories/PROGRAMMING/">PROGRAMMING</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p><a href="https://cloud.google.com/apis/design/" target="_blank" rel="noopener">Google API Design Guide</a></p>
<p>基本上 可以看作是 Google 开放的 API 设计指南。</p>
<p>大体上，Google 对外公开的 API 设计有如下几个特点：</p>
<ol>
<li>resource oriented design</li>
<li>support both gRPC API and REST API</li>
<li>use protobuf for transcoding</li>
</ol>
<p>看到第一点的时候还是相当震惊的。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/03/02/monthly-read-posts-in-feb-2019/">Monthly Read Posts in Feb 2019</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-03-02
        </span>
        
          <div class="post-category">
            
              <a href="/categories/PROGRAMMING/">PROGRAMMING</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <h2 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h2><p><a href="https://www.mnot.net/blog/2018/11/27/header_compression" target="_blank" rel="noopener">Designing Headers for HTTP Compression</a></p>
<p>看起来是 HTTP/2 的 header compression 使用建议</p>
<hr>
<p><a href="https://www.mnot.net/blog/2017/05/11/status_codes" target="_blank" rel="noopener">How to Think About HTTP Status Codes</a></p>
<p>HTTP status codes 使用建议。</p>
<p>适合结合 Rest API design 相关文章一起食用。</p>
<h2 id="Programming-Languages"><a href="#Programming-Languages" class="headerlink" title="Programming Languages"></a>Programming Languages</h2><p><a href="https://tonybai.com/2016/12/21/how-to-use-timer-reset-in-golang-correctly/" target="_blank" rel="noopener">论golang Timer Reset方法使用的正确姿势</a></p>
<p>golang 这破 timer 坑真多</p>
<hr>
<p><a href="https://jonasdevlieghere.com/guaranteed-copy-elision/" target="_blank" rel="noopener">Guaranteed Copy Elision</a></p>
<p>C++ 17 Guaranteed copy elision explained.<br>
          <div class="read-more">
            <a href="/2019/03/02/monthly-read-posts-in-feb-2019/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/02/23/using-sangfor-vpn-on-linux/">在 Linux 上使用深信服 VPN</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-02-23
        </span>
        
          <div class="post-category">
            
              <a href="/categories/CODE-LIFE/">CODE-LIFE</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <p>因为公司使用 Windows 和 MacOS 的人最多，因此导致两个后果：</p>
<ol>
<li>连接公司内网需要使用的深信服 VPN 基本只支持 Windows 和 MacOS</li>
<li>后端 golang 大仓代码基本只能在 MacOS 或者 Linux 上提交和调试</li>
</ol>
<p>求一下交集可以发现，在贵司使用 Linux 作为开发平台的同学应该很难过。很不幸的是，我刚好属于那种在 Linux (虚拟机里跑 Mint) 上写后端服务的人。</p>
<p>公司买的深信服的 VPN 服务，那个客户端虽然官方宣称支持 ubuntu，但是事实是压根不能用，连接成功后一旦有数据包就自动断开。</p>
<p>官方论坛有人反映过类似的问题，得到的回答千篇一律都是推荐使用 Windows 和 MacOS。</p>
<p>然而让我使用屎一样的 MacOS 是不可能的；让我在自己的主力台式机的 Windows 上装深信服的客户端也是不可能的。<br>
          <div class="read-more">
            <a href="/2019/02/23/using-sangfor-vpn-on-linux/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/02/10/use-cmake-and-git-as-your-cpp-dependency-manager/">C++ 工程依赖管理新方向：CMake & Git</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-02-10
        </span>
        
          <div class="post-category">
            
              <a href="/categories/PROGRAMMING/">PROGRAMMING</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <p>本文内容中提及的 CMake 均指提倡 target-based properties 的 <a href="https://kingsamchen.github.io/2018/06/19/modern-cmake/">modern cmake</a>，而非史前版本的 legacy cmake。</p>
<h3 id="The-Right-Way-源码依赖"><a href="#The-Right-Way-源码依赖" class="headerlink" title="The Right Way: 源码依赖"></a>The Right Way: 源码依赖</h3><p>对于 C++ 工程而言，只要 ABI 的问题还存在，源码依赖就是最稳妥最普适最可靠的依赖引入方式；即使这些引入的源码在构建中会单独编译成（动/静态）库。</p>
<p>同时，GitHub 成为开源文化社区的标杆后，获取实现了某一功能的第三方库的源代码的难度大大降低。</p>
<p>因此个人倾向上：只要允许，都应该以特定版本的源码引入的方式去依赖一个第三方库。</p>
<p>事实上，Google Facebook 这些大厂内部实行的 monorepo 也是源码依赖的一种实现方式，因为某个工程需要的依赖源码都可以一并获取到。</p>
<p>在使用 CMake 作为构建系统的工程体系下，要以源码依赖的方式添加一个子工程只需要使用 <code>add_subdirectory()</code> 添加目标工程的顶层目录（根 <code>CMakeLists.txt</code> 所在的目录）。</p>
<h3 id="Git-Submodule-一次不完美的尝试"><a href="#Git-Submodule-一次不完美的尝试" class="headerlink" title="Git Submodule: 一次不完美的尝试"></a>Git Submodule: 一次不完美的尝试</h3><p>我的个人项目 KBase 和 ezio，在此之前都是通过 git submodule 的方式引入自己需要的依赖源代码，然后通过</p>
<ul>
<li>Visual Studio 子工程添加到解决方案（Windows 平台）</li>
<li>CMake <code>add_subdirectory()</code> 建联（*nix 平台）</li>
</ul>
<p>依赖的版本管理直接复用 submodule 提供的特性。<br>
          <div class="read-more">
            <a href="/2019/02/10/use-cmake-and-git-as-your-cpp-dependency-manager/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/02/06/monthly-read-posts-in-jan-2019/">Monthly Read Posts in Jan 2019</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-02-06
        </span>
        
          <div class="post-category">
            
              <a href="/categories/PROGRAMMING/">PROGRAMMING</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h2 id="Programming-Languages"><a href="#Programming-Languages" class="headerlink" title="Programming Languages"></a>Programming Languages</h2><p><a href="https://arne-mertz.de/2015/03/fun-without-keyword-explicit/" target="_blank" rel="noopener">Fun with(out) keyword explicit</a></p>
<p>The old saying goes: <em>When writing a conversion operator or a constructor that can be called with one argument, make it explicit by default.</em></p>
<p>By the way, according to comments from the author, the buggy compiler he used was C++ Builder, from Embarcadero, sigh.</p>
<h2 id="Engineering"><a href="#Engineering" class="headerlink" title="Engineering"></a>Engineering</h2><p><a href="https://arne-mertz.de/2015/03/simple-and-clean-code-vs-performance/" target="_blank" rel="noopener">Simple and Clean Code vs. Performance</a></p>
<ul>
<li>Performance is not efficiency. // ?? I still can’t get this clear in a programming context.</li>
<li>Improve performance after having profiled your system.</li>
<li>Make sure use of correct data structures and algorithms</li>
<li>By default write code for maintainability.</li>
<li>Know and use your libraries, unless your profiler showed them to have bad performance.</li>
</ul>
<h2 id="Concurrency"><a href="#Concurrency" class="headerlink" title="Concurrency"></a>Concurrency</h2><p><a href="https://idea.popcount.org/2012-09-12-reinventing-spinlocks/" target="_blank" rel="noopener">Reinventing spinlocks</a></p>
<p>when implementing spinlock unlock: a simple atomic store is enough. no need for using  a heavy CAS operation.</p>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><p><a href="http://ithare.com/testing-memory-allocators-ptmalloc2-tcmalloc-hoard-jemalloc-while-trying-to-simulate-real-world-loads/" target="_blank" rel="noopener">Testing Memory Allocators: ptmalloc2 vs tcmalloc vs hoard vs jemalloc While Trying to Simulate Real-World Loads</a></p>
<p>Three pre-requisites:</p>
<ul>
<li>test only new/delete (or malloc/free)</li>
<li>use realistic statistic distributions; both for allocated sizes and for lifetime of allocated items</li>
<li>access all memory at least once</li>
</ul>
<p>all for emulating real-world uses.</p>
<p>conclusion:</p>
<ul>
<li>for cpu cycle test, every allocator is not too far from each other. each of them can outperform another one under certain conditions. benchmark is highly recommended when you decide to change your allocator.</li>
<li>some allocators behave not so good in memory overhead, like Hoard.</li>
</ul>
<hr>
<p><a href="https://idea.popcount.org/2012-12-09-lsof-cant-identify-protocol/" target="_blank" rel="noopener">lsof: can’t identify protocol</a></p>
<ul>
<li><code>lsof</code> for listing open files; while</li>
<li><code>netstat</code> for displaying network related information, like connections .etc</li>
</ul>
<p><code>lsof</code> has issues on locating half-closed sockets.</p>
<hr>
<p><a href="https://idea.popcount.org/2012-12-11-linux-process-states/" target="_blank" rel="noopener">Linux process states ptrace tutorial part #1</a></p>
<p>How <code>ptrace</code> relates with linux process states.</p>
<p>using <code>SIGSTOP</code> and <code>SIGCONT</code> to control a process’s state and parent process receives <code>SIGCHLD</code> when child process state changes.</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2019/01/27/made-changes-on-tcp-connection-events-for-ezio/">调整 ezio 的 TCPConnection 状态事件</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-01-27
        </span>
        
          <div class="post-category">
            
              <a href="/categories/PROGRAMMING/">PROGRAMMING</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <p>上上周的时候给 ezio 做了一个<a href="https://github.com/kingsamchen/ezio/commit/d9e7bde28155b5bb2f144dd4c42083d95ef7b674" target="_blank" rel="noopener">调整</a>，稍微修改了一下 <code>TCPConnection</code> 对外暴露的几个状态变化的事件。</p>
<p>起因是在写 <a href="https://github.com/kingsamchen/ezio/blob/9a2ea3ffa43578555e8dfcfe769db10bb45e0087/examples/chat/chat_client.cpp#L62" target="_blank" rel="noopener">example/chat-client</a> 的时候，因为主线程单独跑了一个事件循环从 <code>stdin</code> 中读取用户输入，所以 <code>ChatClient</code> 以及内部的 <code>TCPClient</code> 是跑在另外的工作线程上。</p>
<p>因为那个时候 <code>TCPClient</code> 之对外暴露了 connection 和 disconnection 的事件回调（这两个事件还统一成了一个 <code>on_connection()</code>），所以自然选择在 disconnection 的时候进行退出主循环的操作。</p>
<p>但是这个时候会出现：</p>
<ul>
<li>主循环结束后立马析构 <code>ChatClient</code>，连同内部的 <code>TCPClient</code> 一起销毁。因为这部分代码跑在主线程上，所以不会和工作线程有任何 coordination。</li>
<li><code>TCPClient</code> 会在触发 <code>on_connection()</code> 来表明连接断开后会继续做一些内部清理工作；然而因为前面已经将 <code>TCPClient</code> 析构了，导致 UAF</li>
</ul>
<p>而当时为了解决这个问题，采用的 workaround 时，<code>ChatClient::OnConnection()</code> 在发现连接断开后，通过 <code>RunTaskAfter()</code> 的方式延后执行 <code>EventLoop::Quit()</code>。</p>
<p>这个做法非常丑陋而且不可靠。<br>
          <div class="read-more">
            <a href="/2019/01/27/made-changes-on-tcp-connection-events-for-ezio/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
    
      <a class="next" href="/page/2/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2019

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Kingsley Chen</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
